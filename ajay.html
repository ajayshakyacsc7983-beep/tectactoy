<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Game Arcade: Tic Tac Toe & Bead 16 Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;900&family=Roboto:wght@500&display=swap" rel="stylesheet">
    
    <!-- FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- CONFETTI SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-deep: #05020a;
            --bg-light: #180829;
            --cyan: #00d2ff;
            --pink: #ff47b6;
            --orange: #ff8e42;
            --green: #2ecc71;
            --gold: #ffd700;
            --tile-bg: #2a1b42;
            --font-main: 'Fredoka One', cursive;
            
            /* Bead Game Vars */
            --wood-light: #e6c288;
            --wood-dark: #c19a6b;
            --btn-bead: #d35400;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-deep) 100%);
            color: white; font-family: var(--font-main);
            height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .stars-bg { position: absolute; width: 100%; height: 100%; top:0; left:0; z-index: -1; opacity: 0.3; background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px); background-size: 550px 550px; }
        
        /* --- SCREENS --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; padding: 20px; animation: popIn 0.3s; }
        .active { display: flex; }
        @keyframes popIn { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }

        /* --- LAUNCHER --- */
        .launcher-header { font-size: 2rem; color: white; margin-bottom: 30px; letter-spacing: 2px; text-shadow: 0 0 10px var(--pink); text-transform: uppercase; }
        .game-card-row {
            width: 100%; max-width: 400px; height: 120px;
            background: rgba(0,0,0,0.6); border-radius: 20px;
            margin-bottom: 20px; display: flex; align-items: center; padding: 15px;
            position: relative; overflow: hidden; transition: 0.2s; cursor: pointer;
            border: 2px solid #333;
        }
        .game-card-row.featured {
            border: 2px solid var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            background: linear-gradient(90deg, rgba(255,215,0,0.1), rgba(0,0,0,0.8));
        }
        .game-card-row.secondary { border: 2px solid var(--cyan); background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), rgba(0,0,0,0.8)); }
        .game-card-row:active { transform: scale(0.97); }
        .gc-icon { width: 90px; height: 90px; border-radius: 15px; overflow: hidden; margin-right: 15px; border: 2px solid rgba(255,255,255,0.2); background: #000;}
        .gc-icon img { width: 100%; height: 100%; object-fit: cover; }
        .gc-info { flex: 1; text-align: left; }
        .gc-title { font-size: 1.2rem; color: #fff; margin-bottom: 5px; text-transform: uppercase; }
        .gc-play-btn { display: inline-flex; align-items: center; gap: 5px; font-size: 1.2rem; font-weight: bold; }
        .play-triangle { width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 14px solid white; }

        /* --- UI ELEMENTS (Global) --- */
        .btn-3d {
            width: 100%; max-width: 350px; padding: 14px; margin: 8px 0; border: none; border-radius: 12px;
            font-family: var(--font-main); font-size: 1.1rem; color: white; cursor: pointer; position: relative; top: 0;
            transition: 0.1s; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0px 4px 0px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-3d:active { top: 4px; box-shadow: 0px 0px 0px transparent !important; }
        
        .b-pink { background: var(--pink); box-shadow: 0px 4px 0px #b8006e; }
        .b-orange { background: var(--orange); box-shadow: 0px 4px 0px #bd520b; }
        .b-green { background: var(--green); box-shadow: 0px 4px 0px #1b8a48; }
        .b-blue { background: #00aaff; box-shadow: 0px 4px 0px #0077b3; }
        .b-gold { background: #ffcc00; box-shadow: 0px 4px 0px #c5a800; color: #443300; }
        .b-red { background: #ff3b30; box-shadow: 0px 4px 0px #a3160e; }
        .b-purple { background: #9b59b6; box-shadow: 0px 4px 0px #71368a; }

        .modal-box { background: linear-gradient(135deg, #2b1055, #19052b); width: 95%; max-width: 380px; padding: 25px; border-radius: 25px; text-align: center; color: white; position: relative; border: 2px solid var(--pink); box-shadow: 0 0 30px rgba(255, 71, 182, 0.3); }
        .modal-box.dark-mode { background: rgba(10, 5, 20, 0.95); border: 1px solid var(--gold); }

        /* --- HUD --- */
        .hud-top { position: absolute; top: 15px; left: 0; width: 100%; padding: 0 15px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .currency-cluster { display:flex; gap:10px; pointer-events: auto; }
        .coin-pill, .diamond-pill { background: rgba(0,0,0, 0.6); border: 1px solid rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 5px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; font-weight:bold; color:white;}
        
        /* --- SIDE BUTTONS --- */
        .side-btn-container { position: absolute; top: 80px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 90; }
        .event-float-btn {
            width: 70px; height: 70px; background-size: cover; background-position: center; border-radius: 15px;
            border: 2px solid var(--gold); box-shadow: 0 0 15px var(--gold); cursor: pointer; animation: pulse 2s infinite;
            background-image: url('https://i.ibb.co/q3mxxmJK/premium-vector-1712595408151-8ea5d93477e2.avif');
        }
        .collection-float-btn {
            width: 50px; height: 50px; background: rgba(0,0,0,0.5); border-radius: 12px; border: 2px solid var(--cyan);
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; backdrop-filter: blur(5px);
        }
        .admin-gear { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; color: rgba(255,255,255,0.3); cursor: pointer; z-index: 101; pointer-events: auto;}
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

        /* --- PROFILE --- */
        .profile-bar { width: 100%; max-width: 380px; display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 20px; margin-bottom: 25px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .p-pic { width: 65px; height: 65px; border-radius: 50%; border: 3px solid white; margin-right: 15px; overflow: hidden; background: #333; }
        .p-pic img { width: 100%; height: 100%; object-fit: cover; }
        .p-info { flex: 1; text-align: left; }
        .xp-track { width: 100%; height: 10px; background: rgba(0,0,0,0.4); border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--green), #aaff00); width: 0%; transition: width 0.5s; }

        .game-header { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 380px; margin-bottom: 20px; padding: 0 10px; }
        .player-card { text-align: center; width: 90px; opacity: 0.6; transform: scale(0.9); transition: 0.3s; position:relative; }
        .player-card.active-turn { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 10px white); }
        .av-box { width: 70px; height: 70px; border-radius: 20px; background: #222; border: 3px solid rgba(255,255,255,0.3); overflow: hidden; margin: 0 auto 5px; }
        .av-box.selected { border: 4px solid var(--green); box-shadow: 0 0 15px var(--green); }
        .av-box img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- TIC TAC TOE BOARD --- */
        .board-bg { background: #140521; padding: 15px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; margin-bottom: 20px; border: 4px solid rgba(255,255,255,0.05); }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 12px; width: 85vw; max-width: 320px; height: 85vw; max-height: 320px; }
        .cell { width: 100%; height: 100%; background: var(--tile-bg); border-radius: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 3rem; box-shadow: inset 0 -5px 0 rgba(0,0,0,0.4); overflow: hidden; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
        .cell:active { transform: scale(0.95); }
        .cell.winning { background: #ffffff !important; box-shadow: 0 0 20px 5px white; animation: flash 0.5s infinite alternate; }
        @keyframes flash { from{opacity:1;} to{opacity:0.6;} }

        .skin-img { width: 85%; height: 85%; object-fit: contain; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- LOBBY LIST --- */
        .lobby-list { height: 300px; overflow-y: auto; text-align: left; margin: 10px 0; background: #f5f5f5; border-radius: 10px; padding: 10px; border: inset 2px #ccc; color: #333; }
        .lobby-player { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; margin-bottom: 5px; border-radius: 8px; border: 1px solid #ddd; }
        .status-dot { width: 10px; height: 10px; background: var(--green); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.busy { background: var(--red); }

        /* --- SHOP STYLES --- */
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: #ccc; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--pink); color: white; box-shadow: 0 0 10px var(--pink); }
        .sub-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem; background: transparent; color: #aaa; }
        .sub-btn.active { background: white; color: var(--bg-light); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: 900; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 5px; height: 300px; overflow-y: auto; padding-bottom: 50px; }
        .shop-item { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid rgba(255,255,255,0.1); position: relative; }

        /* --- RING EVENT --- */
        .ring-bg { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 30% 50%, #2a1145 0%, #000 100%); z-index: -1; }
        .ring-container { position: relative; width: 100%; height: 60%; display: flex; justify-content: center; align-items: center; }
        .hex-outer { position: absolute; width: 64px; height: 74px; background: linear-gradient(135deg, #ffd700, #ffaa00); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; justify-content: center; align-items: center; transition: 0.3s; cursor: pointer; }
        .hex-outer.silver { background: linear-gradient(135deg, #ccc, #888); }
        .hex-outer.spinning { background: white !important; box-shadow: 0 0 20px 5px white; z-index: 20; transform: scale(1.1); }
        .hex-inner { width: 58px; height: 68px; background: #1a0b2e; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; justify-content: center; align-items: center; }
        .hex-inner img { width: 80%; height: 80%; object-fit: contain; }
        .hex-outer.selected { transform: scale(1.2); z-index: 10; filter: drop-shadow(0 0 10px gold); }
        .event-controls { width: 100%; height: 40%; display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 10px; position: relative; }
        .preview-area { width: 50%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .preview-item-img { width: 140px; height: 140px; object-fit: contain; filter: drop-shadow(0 0 15px rgba(0,210,255,0.6)); animation: floatItem 3s ease-in-out infinite; }
        @keyframes floatItem { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .spin-btns { width: 45%; display: flex; flex-direction: column; gap: 10px; justify-content: center; }

        /* --- TOAST & MODALS --- */
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: white; color: #333; padding: 15px 25px; border-radius: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 5000; transition: top 0.5s; border: 3px solid var(--green); width: 90%; max-width: 340px; }
        #toast.show { top: 20px; }
        #challenge-modal, #difficulty-modal, #modal-result, #modal-mystery, #modal-admin-login, #modal-congrats { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 4000; display:none; justify-content:center; align-items:center; }
        
        .admin-row { text-align: left; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .admin-row input { width: 100%; padding: 5px; background: #333; border: 1px solid #555; color: white; margin-top: 2px; }
        .admin-section { border: 2px solid #555; border-radius: 10px; padding: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.05); }
        .admin-section h3 { color: var(--gold); border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 10px; }

        /* --- RESULT EFFECTS --- */
        .result-box-win { border: 5px solid var(--gold); background: linear-gradient(135deg, #2b1055 0%, #000 100%); box-shadow: 0 0 50px var(--gold); animation: popIn 0.5s; color: white;}
        .result-box-draw { border: 5px solid #ccc; background: linear-gradient(135deg, #333 0%, #000 100%); box-shadow: 0 0 30px #aaa; }
        
        .mystery-crate { 
            width: 150px; height: 150px; 
            background: url('https://cdn-icons-png.flaticon.com/512/6556/6556066.png') no-repeat center/contain; 
            cursor: pointer; margin: 0 auto;
            transition: transform 0.2s;
        }
        .mystery-crate:active { transform: scale(0.9); }
        .shaking { animation: shakeBox 0.5s infinite; }
        @keyframes shakeBox { 0%{transform:rotate(0) translate(0,0);} 25%{transform:rotate(-10deg) translate(-5px,0);} 75%{transform:rotate(10deg) translate(5px,0);} 100%{transform:rotate(0) translate(0,0);} }

        /* TAUNT */
        #taunt-menu { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border-radius: 20px; padding: 10px; display: none; gap: 10px; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 300px; z-index: 200; border: 2px solid var(--pink); }
        .taunt-btn { width: 40px; height: 40px; font-size: 1.5rem; background: transparent; border: none; cursor: pointer; }
        .float-emoji { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 2rem; animation: floatUp 2s forwards; pointer-events: none; z-index: 200; text-shadow: 0 5px 10px rgba(0,0,0,0.5); }
        @keyframes floatUp { 0%{opacity:1; top:-40px;} 100%{opacity:0; top:-100px;} }

        /* CONGRATS REWARDS */
        #congrats-content { width: 100%; max-width: 500px; padding: 20px; display: flex; flex-direction: column; align-items: center; background: transparent; }
        .congrats-header { font-size: 2.5rem; color: var(--gold); text-shadow: 0 0 20px orange, 0 0 10px yellow; margin-bottom: 30px; animation: popIn 0.5s; letter-spacing: 2px; text-transform: uppercase; }
        .reward-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .reward-card { width: 90px; height: 110px; background: rgba(0,0,0,0.8); border: 2px solid var(--gold); border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: flipIn 0.5s forwards; opacity: 0; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .reward-card.duplicate { border-color: #aaa; box-shadow: none; }
        .reward-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .reward-card span { font-size: 0.6rem; color: #fff; text-align: center; max-width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding: 0 2px;}
        @keyframes flipIn { from { transform: rotateY(90deg); opacity:0; } to { transform: rotateY(0deg); opacity:1; } }

        /* ============================================================ */
        /* --- BEAD 16 GAME SPECIFIC STYLES --- */
        /* ============================================================ */
        #screen-bead16 {
            background-color: #222;
            padding: 0 !important;
            touch-action: none;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
        }

        #bead-hud {
            width: 100%; height: 80px; display: flex;
            justify-content: space-between; align-items: center;
            padding: 0 10px; box-sizing: border-box;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 3px solid #d4a76a;
            z-index: 10;
            position: absolute; top:0; left:0;
        }

        .bead-player-card {
            background: #fdf5e6; border: 2px solid #d4a76a;
            border-radius: 12px; padding: 5px 10px;
            display: flex; flex-direction: column; align-items: center;
            min-width: 80px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            color: #5d3a1a;
        }
        .bead-player-card.active { transform: scale(1.05); border-color: #27ae60; background: #eafaf1; }
        .bp-name { font-weight: bold; font-size: 11px; margin-bottom: 2px;}
        .bp-score-label { font-size: 9px; color: #777; text-transform: uppercase; }
        .bp-score { font-family: 'Fredoka One', cursive; font-size: 22px; color: #d35400; }
        
        #bead-container { 
            position: absolute; top: 80px; bottom: 80px; width: 100%;
            display: flex; justify-content: center; align-items: center; 
            padding: 20px; box-sizing: border-box;
            background: #333;
        }

        canvas#bead-board { 
            border-radius: 8px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
            background-color: #ff9f1c;
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(160, 82, 45, 0.1) 2px, rgba(160, 82, 45, 0.1) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px);
        }

        #bead-controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; pointer-events: none; box-sizing: border-box; z-index: 20; }
        .bead-ctrl-btn { pointer-events: auto; width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; border: 2px solid #d35400; color: #333; }

        .bead-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .bead-modal {
            background: #fff8e1; padding: 25px; border-radius: 20px;
            border: 5px solid #eebb77; text-align: center;
            width: 340px; max-width: 90%; color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: popIn 0.3s ease-out; position: relative;
        }
        .bead-btn {
            background: linear-gradient(to bottom, #f39c12, #d35400);
            border: none; border-bottom: 4px solid #a04000;
            color: white; padding: 12px 0; font-size: 16px;
            border-radius: 30px; cursor: pointer; width: 100%;
            margin: 8px 0; font-family: 'Fredoka One';
        }
        .bead-btn:active { transform: translateY(3px); border-bottom-width: 1px; }
        .grid-2 { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .mode-card { border: 2px solid #ddd; border-radius: 12px; padding: 10px; width: 90px; cursor: pointer; background: white; transition: 0.2s; color: #333; }
        .mode-card.selected { border-color: #27ae60; background: #eafaf1; box-shadow: 0 0 10px #27ae60; transform: translateY(-3px); }
        .mode-icon { width: 50px; height: 50px; margin: 0 auto 5px; background: #eebb77; border-radius: 8px; }

        /* BEAD ONLINE STYLES */
        .online-list-container { text-align: left; margin-top: 10px; max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.5); border-radius: 10px; padding: 5px; }
        .online-player-item { background: white; border: 1px solid #ccc; padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="stars-bg"></div>

    <!-- HUD -->
    <div id="main-hud" class="hud-top" style="display:none">
        <div class="admin-gear" onclick="openAdmin(); playSound('tap')">‚öôÔ∏è</div>
        <div style="flex:1"></div>
        <div class="currency-cluster">
            <div class="coin-pill">ü™ô <span id="coin-disp">0</span></div>
            <div class="diamond-pill" style="border-color:var(--diamond); color:var(--diamond);">üíé <span id="dia-disp">0</span></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"><div style="font-size:2rem">üîî</div><div id="toast-msg" style="font-weight:bold">...</div></div>

    <!-- 0. LAUNCHER -->
    <div id="screen-launcher" class="screen active">
        <div class="launcher-header">GAME LIST</div>
        <div class="game-card-row featured" onclick="enterGame(); playSound('tap')">
            <div class="gc-icon"><img src="https://i.ibb.co/QjxsXHZK/unnamed.png" alt="Tic Tac Toe Logo"></div>
            <div class="gc-info">
                <div class="gc-title" style="color:var(--gold)">TIC TAC TOE</div>
                <div class="gc-play-btn"><div class="play-triangle"></div> PLAY</div>
            </div>
        </div>
        <!-- BEAD 16 INTEGRATION -->
        <div class="game-card-row secondary" onclick="BeadGame.init(); playSound('tap')">
            <div class="gc-icon">
                <img src="https://i.ibb.co/gFdmRn1V/Gemini-Generated-Image-62vqjz62vqjz62vq.png" alt="Bead 16 Logo">
            </div>
            <div class="gc-info">
                <div class="gc-title" style="color:var(--cyan)">BEAD 16 & 12</div>
                <div class="gc-play-btn"><div class="play-triangle"></div> PLAY</div>
            </div>
        </div>
    </div>

    <!-- 1. SETUP -->
    <div id="screen-setup" class="screen">
        <div class="modal-box">
            <h2>CREATE PROFILE</h2>
            <div style="display:flex; justify-content:center; gap:15px; margin:20px 0;">
                <div class="av-box selected" id="setup-boy" onclick="selGen('boy'); playSound('tap')" style="border-color:var(--green)"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix&clothing=blazerAndShirt" alt="Boy"></div>
                <div class="av-box" id="setup-girl" onclick="selGen('girl'); playSound('tap')"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Annie&hair=longHair" alt="Girl"></div>
            </div>
            <input type="text" id="inp-name" placeholder="Enter Name" maxlength="10" style="width:100%; padding:15px; border-radius:15px; border:2px solid #eee; margin-bottom:15px; text-align:center; font-family:var(--font-main);">
            <button class="btn-3d b-green" onclick="saveProfile(); playSound('tap')">START GAME</button>
        </div>
    </div>

    <!-- 2. MENU -->
    <div id="screen-menu" class="screen">
        <div class="side-btn-container">
            <div id="event-btn" class="event-float-btn" onclick="openEvent(); playSound('tap')"></div>
            <div class="collection-float-btn" onclick="openCollection(); playSound('tap')">üéí</div>
        </div>

        <div class="profile-bar">
            <div class="p-pic"><img id="menu-av" src=""></div>
            <div class="p-info">
                <div style="display:flex; justify-content:space-between;"><span id="menu-name" style="font-weight:900;">Player</span> <span id="menu-lvl" style="color:var(--gold)">Lvl 1</span></div>
                <div class="xp-track"><div class="xp-fill" id="menu-xp"></div></div>
            </div>
        </div>

        <h1 style="font-size:3rem; text-align:center; margin-bottom:15px; line-height:0.9;">
            <span style="color:var(--gold); text-shadow:0 0 10px var(--gold)">TIC</span><br><span style="color:var(--pink); text-shadow:0 0 10px var(--pink)">TAC</span><br><span style="color:var(--cyan); text-shadow:0 0 10px var(--cyan)">TOE</span>
        </h1>
        
        <button class="btn-3d b-pink" onclick="preStartAI(); playSound('tap')">ü§ñ VS ROBOT</button>
        <button class="btn-3d b-green" onclick="startLocal(); playSound('tap')">üë• PASS & PLAY</button>
        <button class="btn-3d b-blue" onclick="show('screen-online-select'); playSound('tap')">üåç ONLINE</button>
        <button class="btn-3d b-gold" onclick="show('screen-shop'); playSound('tap')">üõí SHOP</button>
        <button class="btn-3d b-red" style="margin-top:20px; width:auto; padding:10px 30px; font-size:0.9rem;" onclick="show('screen-launcher'); playSound('tap')">‚¨Ö BACK TO LIST</button>
    </div>

    <!-- ======================================================= -->
    <!-- NEW SCREEN: BEAD 16 GAME -->
    <!-- ======================================================= -->
    <div id="screen-bead16" class="screen">
        <!-- GAME HUD -->
        <div id="bead-hud">
            <div class="bead-player-card" id="bp2-card">
                <span class="bp-name" id="bp2-name">Red (CPU)</span>
                <span class="bp-score-label">Captured</span>
                <span class="bp-score" id="b-score-red">0</span>
            </div>
            <div style="text-align:center;">
                <div style="font-size:12px; color:#555; font-weight:bold;">SHOLO GUTI</div>
                <div id="b-status-text" style="font-size:14px; color:#d35400; font-weight:bold;">Your Turn</div>
            </div>
            <div class="bead-player-card" id="bp1-card">
                <span class="bp-name" id="bp1-name">You</span>
                <span class="bp-score-label">Captured</span>
                <span class="bp-score" id="b-score-blue">0</span>
            </div>
        </div>

        <!-- CANVAS AREA -->
        <div id="bead-container">
            <canvas id="bead-board"></canvas>
        </div>

        <!-- BOTTOM BUTTONS -->
        <div id="bead-controls">
            <div class="bead-ctrl-btn" onclick="BeadGame.exit(); playSound('tap')">üè†</div>
            <div class="bead-ctrl-btn" onclick="BeadGame.resetGame(); playSound('tap')">üîÑ</div>
        </div>

        <!-- BEAD MAIN MENU OVERLAY -->
        <div id="bead-menu-overlay" class="bead-overlay">
            <div class="bead-modal">
                <h1 style="color:#d35400">Sholo Guti</h1>
                <div class="grid-2">
                    <div class="mode-card selected" id="opt-16" onclick="BeadGame.setMode(16); playSound('tap')">
                        <div class="mode-icon" style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMCAxMCI+PHBhdGggZD0iTTUgMCBMIDEwIDUgTCA1IDEwIEwgMCA1IFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4NCIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3N2Zz4=') center no-repeat; background-size: 80%;"></div>
                        Bead 16
                    </div>
                    <div class="mode-card" id="opt-12" onclick="BeadGame.setMode(12); playSound('tap')">
                        <div class="mode-icon" style="background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMCAxMCI+PHJlY3QgeD0iMSIgeT0iMSIgd2lkdGg9IjgiIGhlaWdodD0iOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjODg0IiBzdHJva2Utd2lkdGg9IjAuNSIvPjwvc3ZnPg==') center no-repeat; background-size: 80%;"></div>
                        Bead 12
                    </div>
                </div>
                <button class="bead-btn" style="background:linear-gradient(to bottom, #2ecc71, #27ae60)" onclick="BeadGame.startLocal(); playSound('tap')">Local Multiplayer</button>
                <button class="bead-btn" style="background:linear-gradient(to bottom, #3498db, #2980b9)" onclick="BeadGame.startCPU(); playSound('tap')">Play with Computer</button>
                <!-- NEW ONLINE BUTTON -->
                <button class="bead-btn" style="background:linear-gradient(to bottom, #9b59b6, #8e44ad)" onclick="BeadGame.showOnlineMenu(); playSound('tap')">üåç Online Multiplayer</button>
                
                <button class="bead-btn b-red" onclick="BeadGame.exit(); playSound('tap')">Back to Launcher</button>
            </div>
        </div>

        <!-- BEAD ONLINE LOBBY -->
        <div id="bead-online-overlay" class="bead-overlay" style="display:none;">
            <div class="bead-modal" style="border-color:#9b59b6">
                <h2 style="color:#8e44ad">Online Lobby</h2>
                
                <!-- Step 1: Login -->
                <div id="bead-online-step1">
                    <p style="margin:10px 0;">Connect to global server</p>
                    <button class="bead-btn" onclick="BeadGame.registerOnline(); playSound('tap')">Go Online</button>
                    <button class="bead-btn b-red" onclick="BeadGame.closeOnlineMenu(); playSound('tap')">Back</button>
                </div>

                <!-- Step 2: List -->
                <div id="bead-online-step2" style="display:none;">
                    <div style="font-size:12px; color:#555;">Playing as: <b id="bead-my-name">...</b></div>
                    <div id="bead-player-list" class="online-list-container">
                        Searching...
                    </div>
                    <button class="bead-btn" style="background:#2ecc71; margin-top:10px; font-size:14px;" onclick="BeadGame.inviteFriend(); playSound('tap')">üîó Invite Friend (WhatsApp)</button>
                    <button class="bead-btn b-red" style="font-size:14px;" onclick="BeadGame.goOffline(); playSound('tap')">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- BEAD CHALLENGE RECEIVED -->
        <div id="bead-challenge-overlay" class="bead-overlay" style="display:none;">
            <div class="bead-modal">
                <h2>‚öîÔ∏è Challenge!</h2>
                <p id="bead-chal-msg">Player wants to play!</p>
                <div style="display:flex; gap:10px;">
                    <button class="bead-btn" style="background:#2ecc71" onclick="BeadGame.acceptChallenge(); playSound('tap')">Accept</button>
                    <button class="bead-btn b-red" onclick="BeadGame.rejectChallenge(); playSound('tap')">Reject</button>
                </div>
            </div>
        </div>

        <!-- WINNER MODAL -->
        <div id="bead-gameover" class="bead-overlay hidden" style="display:none;">
            <div class="bead-modal">
                <h1 id="b-winner-text" style="color:#333;">You Won!</h1>
                <div style="font-size:60px">üèÜ</div>
                <button class="bead-btn" onclick="BeadGame.resetGame(); playSound('tap')">Play Again</button>
                <button class="bead-btn b-blue" onclick="BeadGame.exit(); playSound('tap')">Main Menu</button>
            </div>
        </div>
    </div>
    <!-- END BEAD 16 SCREEN -->

    <!-- EVENT SCREEN -->
    <div id="screen-event" class="screen">
        <div class="modal-box dark-mode" style="width:100%; height:90vh; max-width:700px; padding:0; overflow:hidden; display:flex; flex-direction:column; border:none; background:transparent;">
            <div class="ring-bg"></div>
            <div class="ring-container" id="ring-container"></div>
            <div class="event-controls">
                <div class="preview-area">
                    <h2 id="preview-name" style="color:var(--gold); font-size:1rem; margin-bottom:5px; text-shadow:0 2px 2px black;">SELECT ITEM</h2>
                    <img id="preview-img" class="preview-item-img" src="">
                    <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">Win from Event</div>
                </div>
                <div class="spin-btns">
                    <button id="btn-spin-1" class="btn-3d b-blue" onclick="spin(1); playSound('tap')" style="font-size:0.9rem;">1 SPIN<br><div style="display:flex;align-items:center;justify-content:center;gap:3px"><span style="color:var(--diamond)">üíé</span> 5</div></button>
                    <button id="btn-spin-5" class="btn-3d b-gold" onclick="spin(5); playSound('tap')" style="font-size:0.9rem;">5 SPINS<br><div style="display:flex;align-items:center;justify-content:center;gap:3px"><span style="color:#443300">üíé</span> 20</div></button>
                </div>
            </div>
            <button class="btn-3d b-red" onclick="show('screen-menu'); playSound('tap')" style="position:absolute; top:10px; right:10px; width:auto; padding:5px 15px; font-size:0.8rem;">X</button>
        </div>
    </div>

    <!-- CONGRATS MODAL -->
    <div id="modal-congrats">
        <div id="congrats-content">
            <div class="congrats-header">CONGRATULATIONS</div>
            <div class="reward-grid" id="reward-list"></div>
            <button class="btn-3d b-gold" style="margin-top:30px; width:150px;" onclick="closeCongrats(); playSound('tap')">OK</button>
        </div>
    </div>

    <!-- COLLECTION SCREEN -->
    <div id="screen-collection" class="screen">
        <div class="modal-box" style="height:90vh; padding:15px; display:flex; flex-direction:column;">
            <h2>MY COLLECTION</h2>
            <p style="font-size:0.8rem; color:#bbb; margin-bottom:10px;">Items you won or bought</p>
            <div id="collection-grid" class="shop-grid"></div>
            <button class="btn-3d b-red" style="margin-top:10px;" onclick="show('screen-menu'); playSound('tap')">CLOSE</button>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="modal-admin-login">
        <div class="modal-box">
            <h2>ADMIN PANEL</h2>
            <input type="email" id="adm-email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0;">
            <input type="password" id="adm-pass" placeholder="Password" style="width:100%; padding:10px; margin:5px 0;">
            <button class="btn-3d b-purple" onclick="adminLogin(); playSound('tap')">LOGIN</button>
            <button class="btn-3d b-red" onclick="document.getElementById('modal-admin-login').style.display='none'; playSound('tap')">CANCEL</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="screen-admin" class="screen">
        <div class="modal-box" style="height:90vh; overflow-y:auto; text-align:left;">
            <h2>ADMIN DASHBOARD</h2>
            <p style="color:var(--green); font-size:0.8rem; margin-bottom:15px;">* Event system is AUTOMATIC.</p>
            <div class="admin-section">
                <h3>ADD SHOP ITEM</h3>
                <input type="text" id="new-id" placeholder="ID" style="width:100%; padding:5px; margin:2px 0; border:1px solid #ccc;">
                <input type="text" id="new-name" placeholder="Name" style="width:100%; padding:5px; margin:2px 0; border:1px solid #ccc;">
                <select id="new-type" style="width:100%; padding:5px; margin:2px 0;">
                    <option value="x">X Skin</option>
                    <option value="o">O Skin</option>
                    <option value="avatar">Avatar</option>
                    <option value="emoji">Emoji</option>
                </select>
                <input type="text" id="new-img" placeholder="Image URL" style="width:100%; padding:5px; margin:2px 0; border:1px solid #ccc;">
                <input type="number" id="new-price" placeholder="Price" style="width:100%; padding:5px; margin:2px 0; border:1px solid #ccc;">
                <button class="btn-3d b-green" onclick="addAdminItem(); playSound('tap')">ADD TO SHOP</button>
            </div>
            <h3 style="margin-top:20px;">EXISTING CUSTOM ITEMS</h3>
            <div id="adm-items-list"></div>
            <button class="btn-3d b-red" onclick="show('screen-menu'); playSound('tap')" style="margin-top:20px;">EXIT ADMIN</button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="screen-shop" class="screen">
        <div class="modal-box" style="height:90vh; padding:15px; display:flex; flex-direction:column;">
            <h2>SHOP</h2>
            <div class="shop-tabs">
                <button class="tab-btn active" id="tab-skins" onclick="switchShopTab('skins'); playSound('tap')">SKINS</button>
                <button class="tab-btn" id="tab-avatars" onclick="switchShopTab('avatars'); playSound('tap')">AVATARS</button>
            </div>
            <div id="skin-sub-tabs" class="sub-tabs">
                <button class="sub-btn active" id="sub-x" onclick="switchSkinType('x'); playSound('tap')">X SKINS</button>
                <button class="sub-btn" id="sub-o" onclick="switchSkinType('o'); playSound('tap')">O SKINS</button>
                <button class="sub-btn" id="sub-e" onclick="switchSkinType('emoji'); playSound('tap')">EMOJIS</button>
            </div>
            <div id="shop-container" class="shop-grid"></div>
            <button class="btn-3d b-red" style="margin-top:10px;" onclick="show('screen-menu'); playSound('tap')">CLOSE</button>
        </div>
    </div>

    <!-- GAME MODALS -->
    <div id="difficulty-modal">
        <div class="modal-box">
            <h2 style="color:white; margin-bottom:5px;">SELECT DIFFICULTY</h2>
            <button class="btn-3d b-green" onclick="selDiff('EASY'); playSound('tap')">üë∂ EASY</button>
            <button class="btn-3d b-orange" onclick="selDiff('HARD'); playSound('tap')">üòé HARD</button>
            <button class="btn-3d b-red" onclick="selDiff('IMPOSSIBLE'); playSound('tap')">ü§ñ IMPOSSIBLE</button>
            <button class="btn-3d b-pink" style="margin-top:20px" onclick="document.getElementById('difficulty-modal').style.display='none'; playSound('tap')">CANCEL</button>
        </div>
    </div>
    
    <div id="screen-online-select" class="screen">
        <div class="modal-box">
            <h2>ONLINE MODE</h2>
            <button class="btn-3d b-blue" onclick="modeLobby(); playSound('tap')">üåç GLOBAL LOBBY</button>
            <button class="btn-3d b-purple" onclick="modeInvite(); playSound('tap')">üîë FRIEND CODE</button>
            <button class="btn-3d b-red" onclick="show('screen-menu'); playSound('tap')">BACK</button>
        </div>
    </div>
    
    <!-- LOBBY SCREEN -->
    <div id="screen-lobby" class="screen">
        <div class="modal-box" style="width:100%; max-width:400px; padding:15px; background:white; color:#333;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>GLOBAL LOBBY</h3>
                <div style="font-size:0.8rem; background:#eee; padding:5px 10px; border-radius:10px;">MY CODE: <b id="my-code-disp" style="color:var(--blue); font-size:1rem;">...</b></div>
            </div>
            <div style="display:flex; gap:10px; margin:15px 0;">
                <button class="btn-3d b-blue" style="font-size:0.8rem; padding:8px;" onclick="switchTab('global'); playSound('tap')">üåè GLOBAL</button>
                <button class="btn-3d b-orange" style="font-size:0.8rem; padding:8px;" onclick="switchTab('code'); playSound('tap')">üî¢ CODE</button>
            </div>
            <div id="tab-global">
                <p style="font-size:0.8rem; color:#777; margin-bottom:5px;">Players Online:</p>
                <div id="lobby-list" class="lobby-list">Searching...</div>
            </div>
            <div id="tab-code" style="display:none; height:250px; flex-direction:column; justify-content:center;">
                <p>Enter Friend's Code to Challenge:</p>
                <input type="number" id="friend-code-in" placeholder="Ex: 4821" style="width:100%; padding:15px; font-size:1.5rem; text-align:center; border:2px solid #ccc; border-radius:10px; margin:10px 0;">
                <button class="btn-3d b-green" onclick="challengeByCode(); playSound('tap')">SEND CHALLENGE ‚öîÔ∏è</button>
            </div>
            <button class="btn-3d b-red" onclick="exitOnline(); playSound('tap')" style="margin-top:10px;">EXIT LOBBY</button>
        </div>
    </div>

    <!-- CHALLENGE MODAL -->
    <div id="challenge-modal">
        <div class="modal-box">
            <h2 style="color:var(--orange)">‚öîÔ∏è CHALLENGE!</h2>
            <p id="chal-msg" style="margin:15px 0; font-size:1.1rem;">Player wants to play!</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-3d b-green" style="width:120px;" id="btn-accept" onclick="playSound('tap')">ACCEPT</button>
                <button class="btn-3d b-red" style="width:120px;" onclick="rejectChallenge(); playSound('tap')">REJECT</button>
            </div>
        </div>
    </div>
    
    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <div class="player-card" id="p1-card"><div class="av-box"><img id="p1-img" src=""></div><div id="p1-name" style="font-size:0.8rem;">YOU</div></div>
            <div style="font-size:2rem; font-weight:900; opacity:0.3;">VS</div>
            <div class="player-card" id="p2-card"><div class="av-box"><img id="p2-img" src=""></div><div id="p2-name" style="font-size:0.8rem;">CPU</div></div>
        </div>
        <div class="board-bg">
            <div class="grid" id="grid"></div>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <div style="font-size:1.2rem; font-weight:bold; color:var(--cyan)" id="turn-ind">YOUR TURN</div>
            <button class="btn-3d b-orange" style="width:60px; height:60px; border-radius:50%; margin: 10px auto; font-size:1.5rem;" onclick="toggleTauntMenu(); playSound('tap')">üí¨</button>
        </div>
        <button class="btn-3d b-red" style="margin-top:10px; width:200px; font-size:0.9rem;" onclick="quitGame(); playSound('tap')">üè† EXIT MATCH</button>
        <div id="taunt-menu"></div>
    </div>

    <!-- MYSTERY BOX (UPDATED) -->
    <div id="modal-mystery">
        <div class="modal-box dark-mode">
            <h2 style="color:var(--gold)">WINNING STREAK!</h2>
            <p style="margin-bottom:20px; color:#aaa;">3 Wins in a row!<br>50% Chance to win 10 Diamonds!</p>
            <div id="mystery-box-anim" class="mystery-crate" onclick="openBox()"></div>
            <p style="margin-top:10px;">Tap to Open</p>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="modal-result">
        <div id="res-box" class="modal-box">
            <div style="font-size:5rem;" id="res-emoji">üèÜ</div>
            <h2 id="res-title" style="color:var(--green);">VICTORY!</h2>
            <p id="res-msg">Well played!</p>
            <div style="display:flex; justify-content:space-around; margin:20px 0; background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                <div><small>XP</small><div id="res-xp" style="font-weight:bold; color:var(--cyan)">+50</div></div>
                <div><small>COINS</small><div id="res-coins" style="font-weight:bold; color:var(--gold)">+20</div></div>
            </div>
            <button class="btn-3d b-green" onclick="restartGame(); playSound('tap')">PLAY AGAIN</button>
            <button class="btn-3d b-pink" onclick="quitGame(); playSound('tap')">MAIN MENU</button>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- SOUND MANAGER (FIXED AS REQUESTED) ---
        const SOUNDS = {
            tap: new Audio('tap sound.mp3'),
            win: new Audio('win sound.mp3'),
            draw: new Audio('game over.mp3'),
            gift: new Audio('geft sound.mp3'),
            event: new Audio('gift event sould.mp3'), // Fixed Name
            spin: new Audio('spin sound.mp3'),
            move: new Audio('x,o sound.mp3')
        };

        function playSound(name) {
            if(SOUNDS[name]) {
                SOUNDS[name].currentTime = 0;
                SOUNDS[name].play().catch(e => console.log("Sound not played yet:", e));
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCTipH79pCrw5p4FVjIKAvx3bKC_EvEAs4",
            authDomain: "tectek-toy-2.firebaseapp.com",
            databaseURL: "https://tectek-toy-2-default-rtdb.firebaseio.com",
            projectId: "tectek-toy-2",
            storageBucket: "tectek-toy-2.firebasestorage.app",
            messagingSenderId: "271041781308",
            appId: "1:271041781308:web:a4d664330a1bfc29196d39"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- BEAD 16 GAME LOGIC NAMESPACED ---
        const BeadGame = {
            canvas: null,
            ctx: null,
            mode: 16,
            playType: 'LOCAL',
            pieces: [],
            turn: 1,
            selectedPiece: null,
            validMoves: [],
            isGameOver: false,
            offsetX: 0,
            offsetY: 0,
            scaleX: 1,
            scaleY: 1,
            initialized: false,
            
            // ONLINE VARS
            onlineId: null,
            onlineName: '',
            roomId: null,
            isHost: false, // Host = 1 (Blue), Guest = -1 (Red)
            onlineListeners: [],
            incomingChallengeId: null,

            init: function() {
                show('screen-bead16');
                if(!this.initialized) {
                    this.canvas = document.getElementById('bead-board');
                    this.ctx = this.canvas.getContext('2d');
                    this.canvas.addEventListener('mousedown', (e) => this.handleInput(e));
                    this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleInput(e.touches[0]); }, {passive:false});
                    window.addEventListener('resize', () => { if(document.getElementById('screen-bead16').classList.contains('active')) this.resizeCanvas(); });
                    this.initialized = true;
                    this.checkUrlForInvite();
                }
                document.getElementById('bead-menu-overlay').style.display = 'flex';
                document.getElementById('bead-gameover').style.display = 'none';
                this.resizeCanvas();
            },

            resizeCanvas: function() {
                const container = document.getElementById('bead-container');
                const maxW = container.clientWidth; 
                const maxH = container.clientHeight;

                if (this.mode === 16) {
                    let newH = maxH;
                    let newW = newH * (2/3);
                    if (newW > maxW) { newW = maxW; newH = newW * (3/2); }
                    this.canvas.width = newW; this.canvas.height = newH;
                } else {
                    const size = Math.min(maxW, maxH);
                    this.canvas.width = size; this.canvas.height = size;
                }

                const margin = this.canvas.width * 0.1;
                if (this.mode === 16) {
                    this.offsetX = margin; this.offsetY = margin;
                    this.scaleX = (this.canvas.width - margin * 2) / 400;
                    this.scaleY = (this.canvas.height - margin * 2) / 600;
                } else {
                    // Bead 12 scaling
                    this.offsetX = 0; this.offsetY = 0; // Handled in coord calc
                }
                if(this.pieces.length) this.initBoard(this.mode, false); 
                this.draw();
            },

            exit: function() {
                this.exitOnline();
                document.getElementById('screen-bead16').classList.remove('active');
                show('screen-launcher');
            },

            setMode: function(m) {
                this.mode = m;
                document.getElementById('opt-16').classList.toggle('selected', m===16);
                document.getElementById('opt-12').classList.toggle('selected', m===12);
            },

            startLocal: function() {
                this.playType = 'LOCAL';
                this.startGame("You", "Player 2");
            },

            startCPU: function() {
                this.playType = 'CPU';
                this.startGame("You", "Computer");
            },

            startGame: function(p1, p2) {
                document.getElementById('bead-menu-overlay').style.display = 'none';
                document.getElementById('bead-online-overlay').style.display = 'none';
                document.getElementById('bp1-name').innerText = p1;
                document.getElementById('bp2-name').innerText = p2;
                this.resizeCanvas();
                this.resetGame();
            },

            resetGame: function() {
                document.getElementById('bead-gameover').style.display = 'none';
                this.turn = 1;
                this.isGameOver = false;
                this.selectedPiece = null;
                this.validMoves = [];
                this.initBoard(this.mode, true);
                this.updateUI();
                this.draw();

                // Reset Online Board if Host
                if(this.playType === 'ONLINE' && this.isHost && this.roomId) {
                    db.ref('bead_rooms/' + this.roomId).update({ board: this.pieces.map(p => p.p), turn: 1 });
                }
            },

            // --- ONLINE SYSTEM ---
            showOnlineMenu: function() {
                document.getElementById('bead-menu-overlay').style.display = 'none';
                document.getElementById('bead-online-overlay').style.display = 'flex';
                document.getElementById('bead-online-step1').style.display = 'block';
                document.getElementById('bead-online-step2').style.display = 'none';
            },

            closeOnlineMenu: function() {
                document.getElementById('bead-online-overlay').style.display = 'none';
                document.getElementById('bead-menu-overlay').style.display = 'flex';
            },

            registerOnline: function() {
                this.onlineName = user.name || "Player";
                this.onlineId = user.id || Math.floor(Math.random()*1000000);
                
                document.getElementById('bead-online-step1').style.display = 'none';
                document.getElementById('bead-online-step2').style.display = 'block';
                document.getElementById('bead-my-name').innerText = this.onlineName;

                // Set Presence
                const ref = db.ref('bead_online/' + this.onlineId);
                ref.set({ name: this.onlineName, status: 'idle' });
                ref.onDisconnect().remove();

                // Listen for Players
                const listRef = db.ref('bead_online');
                listRef.on('value', s => {
                    const list = document.getElementById('bead-player-list');
                    list.innerHTML = "";
                    const users = s.val();
                    if(!users) { list.innerHTML = "No players found."; return; }
                    Object.keys(users).forEach(uid => {
                        if(uid == this.onlineId) return;
                        const u = users[uid];
                        const btn = u.status === 'idle' ? 
                            `<button class="bead-btn" style="width:auto;padding:5px 15px;margin:0;font-size:12px;" onclick="BeadGame.sendChallenge('${uid}'); playSound('tap')">Play</button>` :
                            `<span style="color:red;font-size:12px;">Busy</span>`;
                        
                        list.innerHTML += `
                            <div class="online-player-item">
                                <div><span class="status-dot ${u.status==='idle'?'':'busy'}"></span> <b>${u.name}</b></div>
                                ${btn}
                            </div>
                        `;
                    });
                });
                this.onlineListeners.push(listRef);

                // Listen for Challenges
                const chalRef = db.ref('bead_challenges/' + this.onlineId);
                chalRef.on('value', s => {
                    const d = s.val();
                    if(d) {
                        this.incomingChallengeId = d.from;
                        document.getElementById('bead-chal-msg').innerText = d.name + " wants to play Bead " + d.mode + "!";
                        document.getElementById('bead-challenge-overlay').style.display = 'flex';
                    } else {
                        document.getElementById('bead-challenge-overlay').style.display = 'none';
                    }
                });
                this.onlineListeners.push(chalRef);

                // Check Response (If I challenged someone)
                const respRef = db.ref('bead_chal_resp/' + this.onlineId);
                respRef.on('value', s => {
                    const d = s.val();
                    if(d && d.accepted) {
                        this.roomId = d.roomId;
                        this.isHost = true; // Challenger is Host (Blue)
                        this.playType = 'ONLINE';
                        this.startGame(this.onlineName, d.guestName);
                        this.listenToRoom();
                        respRef.remove();
                    }
                });
                this.onlineListeners.push(respRef);
            },

            sendChallenge: function(targetId) {
                db.ref('bead_challenges/' + targetId).set({
                    from: this.onlineId,
                    name: this.onlineName,
                    mode: this.mode
                });
                showToast("Challenge Sent! ‚è≥");
            },

            acceptChallenge: function() {
                if(!this.incomingChallengeId) return;
                const newRoom = db.ref('bead_rooms').push();
                this.roomId = newRoom.key;
                
                // Init Room
                newRoom.set({
                    board: [0], // Placeholder
                    turn: 1,
                    mode: this.mode // Acceptor sets mode? Or challenger? For simplicity, current mode.
                });

                // Tell challenger
                db.ref('bead_chal_resp/' + this.incomingChallengeId).set({
                    accepted: true,
                    roomId: this.roomId,
                    guestName: this.onlineName
                });

                // Clear my challenge
                db.ref('bead_challenges/' + this.onlineId).remove();

                // Start
                this.isHost = false; // Acceptor is Guest (Red)
                this.playType = 'ONLINE';
                this.startGame("Opponent", "You"); // Host is Blue, I am Red
                this.listenToRoom();
            },

            rejectChallenge: function() {
                db.ref('bead_challenges/' + this.onlineId).remove();
            },

            listenToRoom: function() {
                db.ref('bead_online/' + this.onlineId).update({ status: 'playing' });
                
                const rRef = db.ref('bead_rooms/' + this.roomId);
                rRef.on('value', s => {
                    const d = s.val();
                    if(!d) { alert("Opponent disconnected"); this.goOffline(); return; }

                    if(d.mode) this.setMode(d.mode);
                    if(d.board && d.board.length > 1) {
                         // Sync board state
                         this.pieces.forEach((p, i) => p.p = d.board[i]);
                    }
                    this.turn = d.turn;
                    this.countScore();
                    this.updateUI();
                    this.draw();
                    
                    // Check Win
                    const reds = this.pieces.filter(p=>p.p===-1).length;
                    const blues = this.pieces.filter(p=>p.p===1).length;
                    if(reds===0) this.endGame("Blue Won!");
                    if(blues===0) this.endGame("Red Won!");
                });
                this.onlineListeners.push(rRef);
            },

            goOffline: function() {
                this.exitOnline();
                this.showOnlineMenu();
            },

            exitOnline: function() {
                this.onlineListeners.forEach(l => l.off());
                this.onlineListeners = [];
                if(this.onlineId) {
                    db.ref('bead_online/' + this.onlineId).remove();
                    db.ref('bead_challenges/' + this.onlineId).remove();
                    db.ref('bead_chal_resp/' + this.onlineId).remove();
                }
                if(this.roomId) db.ref('bead_rooms/' + this.roomId).remove();
                this.roomId = null;
                this.playType = 'LOCAL';
            },

            inviteFriend: function() {
                const inviteRoom = db.ref('bead_rooms').push();
                this.roomId = inviteRoom.key;
                this.isHost = true;
                
                inviteRoom.set({ host: this.onlineName, status: 'waiting', board:[0], turn:1, mode:this.mode });

                // Wait for friend
                inviteRoom.on('value', s => {
                    const d = s.val();
                    if(d && d.guest) {
                        this.playType = 'ONLINE';
                        this.startGame(this.onlineName, d.guest);
                        inviteRoom.off();
                        this.listenToRoom();
                    }
                });

                const link = window.location.href.split('?')[0] + '?beadroom=' + this.roomId;
                const msg = `Play Bead ${this.mode} with me! ${link}`;
                window.open(`whatsapp://send?text=${encodeURIComponent(msg)}`);
            },

            checkUrlForInvite: function() {
                const params = new URLSearchParams(window.location.search);
                const rid = params.get('beadroom');
                if(rid) {
                    this.roomId = rid;
                    this.onlineName = user.name || "Guest";
                    this.onlineId = user.id || Math.floor(Math.random()*1000);
                    this.isHost = false;
                    
                    db.ref('bead_rooms/' + rid).transaction(r => {
                        if(r && r.status === 'waiting') {
                            r.status = 'playing';
                            r.guest = this.onlineName;
                            return r;
                        }
                    }, (err, comm, snap) => {
                        if(comm) {
                            const val = snap.val();
                            this.setMode(val.mode || 16);
                            this.playType = 'ONLINE';
                            this.init(); // ensure canvas ready
                            this.startGame(val.host, this.onlineName);
                            this.listenToRoom();
                        } else {
                            alert("Link expired or room full.");
                        }
                    });
                }
            },
            // --- END ONLINE SYSTEM ---

            initBoard: function(mode, resetPieces) {
                if (!resetPieces && this.pieces.length > 0) {
                    if (mode === 16) this.updateCoords16(); else this.updateCoords12();
                    return;
                }
                this.pieces = [];
                if (mode === 16) this.setupBead16(); else this.setupBead12();
                this.countScore();
            },

            setupBead16: function() {
                const add = (r, c, p) => this.pieces.push({r, c, p, x:0, y:0, neighbors:[]});
                // Top Triangle (-1 Red)
                add(0,1,-1); add(0,2,-1); add(0,3,-1); add(1,1,-1); add(1,2,-1); add(1,3,-1);
                // Grid Top
                for(let c=0; c<5; c++) add(2, c, -1);
                for(let c=0; c<5; c++) add(3, c, -1);
                // Middle Empty
                for(let c=0; c<5; c++) add(4, c, 0);
                // Grid Bottom (+1 Blue)
                for(let c=0; c<5; c++) add(5, c, 1);
                for(let c=0; c<5; c++) add(6, c, 1);
                // Bottom Triangle
                add(7,1,1); add(7,2,1); add(7,3,1); add(8,1,1); add(8,2,1); add(8,3,1);
                this.updateCoords16(); this.buildConnections16();
            },

            updateCoords16: function() {
                this.pieces.forEach(p => {
                    let lx, ly;
                    if (p.r === 0) { lx = 100 * p.c; ly = 0; } 
                    else if (p.r === 1) { lx = 150 + (p.c - 1) * 50; ly = 50; } 
                    else if (p.r >= 2 && p.r <= 6) { lx = p.c * 100; ly = 100 + (p.r - 2) * 100; } 
                    else if (p.r === 7) { lx = 150 + (p.c - 1) * 50; ly = 550; } 
                    else if (p.r === 8) { lx = 100 * p.c; ly = 600; }
                    p.x = this.offsetX + lx * this.scaleX;
                    p.y = this.offsetY + ly * this.scaleY;
                });
            },

            buildConnections16: function() {
                const threshold = (this.canvas.width / 400) * 130; 
                this.pieces.forEach((p, i) => {
                    p.neighbors = [];
                    this.pieces.forEach((n, j) => {
                        if(i===j) return;
                        let connected = false;
                        const dist = Math.hypot(p.x - n.x, p.y - n.y);
                        if (p.r >= 2 && p.r <= 6 && n.r >= 2 && n.r <= 6) {
                            const dr = Math.abs(p.r - n.r);
                            const dc = Math.abs(p.c - n.c);
                            if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) connected = true;
                            else if (dr === 1 && dc === 1) {
                                if ((p.r + p.c) % 2 === 0) connected = true;
                            }
                        }
                        else if ( (p.r < 2 && n.r < 3) || (p.r > 6 && n.r > 5) ) {
                             if (Math.abs(p.r - n.r) <= 1 && dist < threshold) {
                                 if (!((p.r === 1 && n.r === 2) || (p.r === 2 && n.r === 1) || (p.r === 6 && n.r === 7) || (p.r === 7 && n.r === 6))) connected = true;
                             }
                        }
                        if ( (p.r === 1 && n.r === 2) || (p.r === 2 && n.r === 1) || (p.r === 6 && n.r === 7) || (p.r === 7 && n.r === 6) ) {
                             if (p.c === 2 && n.c === 2) connected = true;
                        }
                        if (connected) p.neighbors.push(j);
                    });
                });
            },

            setupBead12: function() {
                const add = (r, c, p) => this.pieces.push({r, c, p, x:0, y:0, neighbors:[]});
                for(let r=0; r<2; r++) for(let c=0; c<5; c++) add(r, c, -1);
                add(2,0,-1); add(2,1,-1); add(2,2,0); add(2,3,1); add(2,4,1);
                for(let r=3; r<5; r++) for(let c=0; c<5; c++) add(r, c, 1);
                this.updateCoords12(); this.buildConnections12();
            },

            updateCoords12: function() {
                const size = this.canvas.width; const pad = size * 0.12; const step = (size - pad*2) / 4;
                this.pieces.forEach(p => { p.x = pad + p.c * step; p.y = pad + p.r * step; });
            },

            buildConnections12: function() {
                this.pieces.forEach((p, i) => {
                    this.pieces.forEach((n, j) => {
                        if(i===j) return;
                        const dr = Math.abs(p.r - n.r), dc = Math.abs(p.c - n.c);
                        if ((dr===1 && dc===0) || (dr===0 && dc===1)) p.neighbors.push(j); 
                        else if (dr===1 && dc===1 && (p.r+p.c)%2===0 && (n.r+n.c)%2===0) p.neighbors.push(j);
                    });
                });
            },

            handleInput: function(e) {
                if (this.isGameOver) return;
                // Online Check
                if (this.playType === 'ONLINE') {
                    if (this.isHost && this.turn !== 1) return;
                    if (!this.isHost && this.turn !== -1) return;
                }
                if (this.playType === 'CPU' && this.turn === -1) return;

                const rect = this.canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left, my = e.clientY - rect.top;
                const hitRadius = (this.canvas.width / 10); 
                let clickedIdx = -1, minDst = 9999;
                this.pieces.forEach((p, i) => {
                    const dst = Math.hypot(p.x - mx, p.y - my);
                    if (dst < hitRadius && dst < minDst) { clickedIdx = i; minDst = dst; }
                });
                if (clickedIdx === -1) { this.selectedPiece = null; this.validMoves = []; this.draw(); return; }
                const p = this.pieces[clickedIdx];
                if (p.p === this.turn) {
                    this.selectedPiece = clickedIdx; this.calcMoves(clickedIdx); this.draw();
                } else if (p.p === 0 && this.selectedPiece !== null) {
                    const move = this.validMoves.find(m => m.target === clickedIdx);
                    if (move) this.executeMove(move);
                }
            },

            calcMoves: function(idx) {
                this.validMoves = [];
                const p = this.pieces[idx];
                p.neighbors.forEach(nIdx => {
                    const n = this.pieces[nIdx];
                    if (n.p === 0) this.validMoves.push({target: nIdx, jump: false});
                    else if (n.p === -this.turn) {
                        const dx = n.x - p.x, dy = n.y - p.y;
                        n.neighbors.forEach(landIdx => {
                            const land = this.pieces[landIdx];
                            if (landIdx === idx) return; 
                            const dx2 = land.x - n.x, dy2 = land.y - n.y;
                            if (Math.abs(dx*dy2 - dy*dx2) < 200 && (dx*dx2 + dy*dy2) > 0 && land.p === 0) {
                                this.validMoves.push({target: landIdx, jump: true, kill: nIdx});
                            }
                        });
                    }
                });
            },

            executeMove: function(move) {
                playSound('move');
                const from = this.selectedPiece;
                const to = move.target;
                this.pieces[to].p = this.pieces[from].p; this.pieces[from].p = 0;
                if (move.jump) { this.pieces[move.kill].p = 0; showToast("Goti Captured!"); }
                this.selectedPiece = null; this.validMoves = []; this.countScore();
                
                const reds = this.pieces.filter(p=>p.p===-1).length;
                const blues = this.pieces.filter(p=>p.p===1).length;
                if (reds === 0 || blues === 0) {
                    this.isGameOver = true;
                    this.endGame(reds === 0 ? "Blue Won!" : "Red Won!");
                } else {
                    this.turn = -this.turn;
                    this.updateUI();
                }
                this.draw();

                // SYNC MOVE
                if (this.playType === 'ONLINE') {
                    db.ref('bead_rooms/' + this.roomId).update({ board: this.pieces.map(p => p.p), turn: this.turn });
                }

                if (this.playType === 'CPU' && !this.isGameOver && this.turn === -1) setTimeout(() => this.cpuMove(), 600);
            },

            cpuMove: function() {
                const moves = [];
                this.pieces.forEach((p, idx) => {
                    if (p.p === -1) {
                        p.neighbors.forEach(nIdx => {
                            if (this.pieces[nIdx].p === 0) moves.push({from: idx, to: nIdx, jump: false});
                            else if (this.pieces[nIdx].p === 1) {
                                const n = this.pieces[nIdx];
                                const dx = n.x - p.x; const dy = n.y - p.y;
                                n.neighbors.forEach(lIdx => {
                                    const land = this.pieces[lIdx];
                                    if (lIdx === idx) return;
                                    const dx2 = land.x - n.x; const dy2 = land.y - n.y;
                                    if (Math.abs(dx*dy2 - dy*dx2) < 200 && (dx*dx2 + dy*dy2) > 0 && land.p===0) {
                                        moves.push({from: idx, to: lIdx, jump: true, kill: nIdx});
                                    }
                                });
                            }
                        });
                    }
                });
                if (moves.length === 0) return;
                const jumps = moves.filter(m => m.jump);
                const move = jumps.length > 0 ? jumps[Math.floor(Math.random()*jumps.length)] : moves[Math.floor(Math.random()*moves.length)];
                this.selectedPiece = move.from;
                this.validMoves = [{target: move.to, jump: move.jump, kill: move.kill}];
                this.executeMove(this.validMoves[0]);
            },

            countScore: function() {
                const total = this.mode === 16 ? 16 : 12;
                const redLeft = this.pieces.filter(p=>p.p===-1).length;
                const blueLeft = this.pieces.filter(p=>p.p===1).length;
                document.getElementById('b-score-red').innerText = (total - redLeft);
                document.getElementById('b-score-blue').innerText = (total - blueLeft);
            },

            updateUI: function() {
                const p1 = document.getElementById('bp1-card');
                const p2 = document.getElementById('bp2-card');
                const stat = document.getElementById('b-status-text');
                p1.classList.remove('active'); p2.classList.remove('active');
                
                // Labels for Online
                if(this.playType === 'ONLINE') {
                    if(this.turn === 1) {
                         p1.classList.add('active');
                         stat.innerText = this.isHost ? "Your Turn" : "Opponent's Turn";
                         stat.style.color = '#2980b9';
                    } else {
                         p2.classList.add('active');
                         stat.innerText = !this.isHost ? "Your Turn" : "Opponent's Turn";
                         stat.style.color = '#c0392b';
                    }
                    return;
                }

                if (this.turn === 1) { 
                    p1.classList.add('active');
                    stat.innerText = "Your Turn"; stat.style.color = '#2980b9';
                } else { 
                    p2.classList.add('active');
                    stat.innerText = (this.playType === 'CPU') ? "CPU Thinking..." : "Red's Turn"; stat.style.color = '#c0392b';
                }
            },

            endGame: function(msg) {
                if(msg.includes("Blue") || msg.includes("You")) playSound('win'); else playSound('draw');
                document.getElementById('b-winner-text').innerText = msg;
                document.getElementById('bead-gameover').style.display = 'flex';
            },

            draw: function() {
                if(!this.ctx) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = '#4a2c0f'; this.ctx.lineWidth = 3; this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round';
                
                if (this.mode === 16) {
                    const tx = (val) => this.offsetX + val * this.scaleX;
                    const ty = (val) => this.offsetY + val * this.scaleY;
                    const line = (x1, y1, x2, y2) => { this.ctx.beginPath(); this.ctx.moveTo(tx(x1), ty(y1)); this.ctx.lineTo(tx(x2), ty(y2)); this.ctx.stroke(); };
                    line(0,100,0,500); line(100,100,100,500); line(200,100,200,500); line(300,100,300,500); line(400,100,400,500);
                    line(0,100,400,100); line(0,200,400,200); line(0,300,400,300); line(0,400,400,400); line(0,500,400,500);
                    line(0,100,400,500); line(400,100,0,500);
                    line(200,100,400,300); line(400,300,200,500); line(200,500,0,300); line(0,300,200,100);
                    line(100,0,300,0); line(100,0,200,100); line(300,0,200,100); line(200,0,200,100); line(150,50,250,50);
                    line(100,600,300,600); line(100,600,200,500); line(300,600,200,500); line(200,500,200,600); line(150,550,250,550);
                } else {
                    this.ctx.beginPath();
                    this.pieces.forEach((p, i) => {
                        p.neighbors.forEach(nIdx => {
                            if (nIdx > i) { const n = this.pieces[nIdx]; this.ctx.moveTo(p.x, p.y); this.ctx.lineTo(n.x, n.y); }
                        });
                    });
                    this.ctx.stroke();
                }

                if (this.selectedPiece !== null) {
                    this.validMoves.forEach(m => {
                        const t = this.pieces[m.target];
                        this.ctx.beginPath(); this.ctx.arc(t.x, t.y, this.canvas.width/25, 0, Math.PI*2);
                        this.ctx.fillStyle = 'rgba(39, 174, 96, 0.7)'; this.ctx.fill();
                    });
                }

                this.pieces.forEach((p, i) => {
                    if (p.p === 0) return;
                    const r = this.canvas.width / 24; 
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, r, 0, Math.PI*2);
                    const grad = this.ctx.createRadialGradient(p.x-r/3, p.y-r/3, r/4, p.x, p.y, r);
                    grad.addColorStop(0, p.p===1 ? '#5dade2' : '#e74c3c');
                    grad.addColorStop(1, p.p===1 ? '#154360' : '#641e16');
                    this.ctx.fillStyle = grad; 
                    this.ctx.shadowColor = 'rgba(0,0,0,0.5)'; this.ctx.shadowBlur = 4; this.ctx.shadowOffsetY = 2;
                    this.ctx.fill(); this.ctx.shadowBlur = 0; this.ctx.shadowOffsetY = 0;
                    if (i === this.selectedPiece) { this.ctx.strokeStyle = '#f1c40f'; this.ctx.lineWidth = 3; this.ctx.stroke(); }
                });
            }
        };
        // --- END BEAD 16 LOGIC ---

        // --- FULL ASSETS (ALL ITEMS ADDED) ---
        const SKINS = [
            // DEFAULTS
            { id: 'def_x', name: 'Default X', price: 0, type: 'x', img: null },
            { id: 'def_o', name: 'Default O', price: 0, type: 'o', img: null },
            // NEW ITEMS
            { id: 'new_x1', name: 'Magma X', price: 2000, type: 'x', img: 'https://i.ibb.co/jPTYMRM4/5.png' },
            { id: 'new_o1', name: 'Venom O', price: 2000, type: 'o', img: 'https://i.ibb.co/fPnvT2K/6.png' },
            { id: 'new_emo1', name: 'Laugh', type: 'emoji', img: 'https://i.ibb.co/dw6m5QmQ/7.png', price: 1000 },
            { id: 'new_emo2', name: 'Cry', type: 'emoji', img: 'https://i.ibb.co/WNcjzZyq/8.png', price: 1000 },
            // OLD SKINS (ALL RESTORED)
            { id: 'x3', name: 'Blue Lightning', price: 1000, type: 'x', img: 'https://i.ibb.co/M5f6XKgj/3.png' },
            { id: 'x5', name: 'Red Slash', price: 1500, type: 'x', img: 'https://i.ibb.co/SwQH7v33/5.png' },
            { id: 'x6', name: 'Green Venom', price: 2000, type: 'x', img: 'https://i.ibb.co/1GXXKMHD/6.png' },
            { id: 'x7', name: 'Orange Fire', price: 2500, type: 'x', img: 'https://i.ibb.co/8DjNNp5F/7.png' },
            { id: 'x9', name: 'Purple Haze', price: 3000, type: 'x', img: 'https://i.ibb.co/dw2TNwNv/9.png' },
            { id: 'x11', name: 'Cyber Blue', price: 3500, type: 'x', img: 'https://i.ibb.co/W7Fn3Nt/11.png' },
            { id: 'x13', name: 'Golden X', price: 5000, type: 'x', img: 'https://i.ibb.co/fGGKfFz4/13.png' },
            { id: 'x15', name: 'Neon Pink', price: 4000, type: 'x', img: 'https://i.ibb.co/NdYKkF7V/15.png' },
            { id: 'x17', name: 'Toxic Slime', price: 4500, type: 'x', img: 'https://i.ibb.co/vvqqJgSD/17.png' },
            { id: 'x19', name: 'Dark Void', price: 6000, type: 'x', img: 'https://i.ibb.co/hQfGm0q/19.png' },
            { id: 'x21', name: 'Ice Shard', price: 5500, type: 'x', img: 'https://i.ibb.co/JR10ysxS/21.png' },
            { id: 'x23', name: 'Magma X', price: 7000, type: 'x', img: 'https://i.ibb.co/vx6RZW78/23.png' },
            { id: 'xRare', name: 'LEGEND X', price: 10000, type: 'x', img: 'https://i.ibb.co/jvwt95ps/Dec-18-2025-08-30-22-AM-Photoroom.png' },
            { id: 'x1', name: 'Basic Blue', price: 1000, type: 'x', img: 'https://i.ibb.co/1tJSMW0S/1.png' },
            { id: 'x2', name: 'Basic Red', price: 1000, type: 'x', img: 'https://i.ibb.co/Psn3CqDZ/2.png' },
            { id: 'x3j', name: 'Metal X', price: 8000, type: 'x', img: 'https://i.ibb.co/7tfjBCW1/3.jpg' },
            { id: 'x5a', name: 'Soft X', price: 1200, type: 'x', img: 'https://i.ibb.co/20G0hYNn/5.png' },
            { id: 'x37', name: 'Glitch X', price: 9000, type: 'x', img: 'https://i.ibb.co/4w8RBRTN/37.png' },
            { id: 'x41', name: 'Pro X', price: 9500, type: 'x', img: 'https://i.ibb.co/GQNQ2xtt/41.png' },
            { id: 'x10', name: 'Viper X', price: 3000, type: 'x', img: 'https://i.ibb.co/rf0vT3ZG/10.png' },
            { id: 'x12', name: 'Ghost X', price: 3500, type: 'x', img: 'https://i.ibb.co/KzfxrcTT/12.png' },
            { id: 'x13a', name: 'Sun X', price: 4000, type: 'x', img: 'https://i.ibb.co/3Y1073FD/13.png' },
            { id: 'x15a', name: 'Shadow X', price: 4500, type: 'x', img: 'https://i.ibb.co/RkjQNssN/15.png' },
            { id: 'x16', name: 'Blood X', price: 5000, type: 'x', img: 'https://i.ibb.co/gbJ5JVfR/16.png' },
            { id: 'x17a', name: 'Tech X', price: 5500, type: 'x', img: 'https://i.ibb.co/DHYs3pYh/17.png' },
            { id: 'x19a', name: 'Spirit X', price: 6000, type: 'x', img: 'https://i.ibb.co/tp63TYM4/19.png' },
            { id: 'x20', name: 'Demon X', price: 6500, type: 'x', img: 'https://i.ibb.co/vCy13W4Z/20.png' },
            { id: 'x21a', name: 'Angel X', price: 7000, type: 'x', img: 'https://i.ibb.co/kV3Sz044/21.png' },
            { id: 'x23a', name: 'God X', price: 7500, type: 'x', img: 'https://i.ibb.co/Hp17zmGk/23.png' },
            { id: 'x24', name: 'Titan X', price: 8000, type: 'x', img: 'https://i.ibb.co/35HZN5tp/24.png' },
            { id: 'x25', name: 'Dragon X', price: 8500, type: 'x', img: 'https://i.ibb.co/Xkx1w9mm/25.png' },
            { id: 'x27', name: 'Void X', price: 9000, type: 'x', img: 'https://i.ibb.co/QvY9xk0z/27.png' },
            { id: 'x28', name: 'Cosmic X', price: 9200, type: 'x', img: 'https://i.ibb.co/prZh2QcQ/28.png' },
            { id: 'x29', name: 'Aura X', price: 9400, type: 'x', img: 'https://i.ibb.co/1tdzbDk5/29.png' },
            { id: 'x30', name: 'Pixel X', price: 9600, type: 'x', img: 'https://i.ibb.co/FkW8LC3H/30.png' },
            { id: 'x32', name: 'Mecha X', price: 9800, type: 'x', img: 'https://i.ibb.co/hJRqLcPx/32.png' },
            { id: 'x35', name: 'Cyber X', price: 9900, type: 'x', img: 'https://i.ibb.co/hRWTQ5Pr/35.png' },
            { id: 'x36', name: 'Holo X', price: 9950, type: 'x', img: 'https://i.ibb.co/fVqqvFBR/36.png' },
            { id: 'x38', name: 'Nano X', price: 9999, type: 'x', img: 'https://i.ibb.co/J1G0KnG/38.png' },
            { id: 'x39', name: 'Quantum X', price: 9999, type: 'x', img: 'https://i.ibb.co/99pF57dJ/39.png' },
            { id: 'x40', name: 'Plasma X', price: 9999, type: 'x', img: 'https://i.ibb.co/cc8B1696/40.png' },
            // O SKINS
            { id: 'o2', name: 'Blue Ring', price: 1000, type: 'o', img: 'https://i.ibb.co/BHTrxC4M/2.png' },
            { id: 'o4', name: 'Metal O', price: 1500, type: 'o', img: 'https://i.ibb.co/d08xXwhP/4.jpg' },
            { id: 'o4a', name: 'Soft O', price: 1500, type: 'o', img: 'https://i.ibb.co/sd5pYGtp/4.png' },
            { id: 'o8', name: 'Green O', price: 2000, type: 'o', img: 'https://i.ibb.co/jP7WYjxc/8.png' },
            { id: 'o8a', name: 'Acid O', price: 2000, type: 'o', img: 'https://i.ibb.co/Cp2sXnJt/8.png' },
            { id: 'o10', name: 'Sun O', price: 2500, type: 'o', img: 'https://i.ibb.co/vCKtxspS/10.png' },
            { id: 'o11', name: 'Pink O', price: 3000, type: 'o', img: 'https://i.ibb.co/bRzfhgRC/11.png' },
            { id: 'o12', name: 'Cyan O', price: 3500, type: 'o', img: 'https://i.ibb.co/W4PkZJZk/12.png' },
            { id: 'o14', name: 'Orange O', price: 4000, type: 'o', img: 'https://i.ibb.co/XrK2zw6B/14.png' },
            { id: 'o16', name: 'Purple O', price: 4500, type: 'o', img: 'https://i.ibb.co/PGQtTSrm/16.png' },
            { id: 'o18', name: 'Red O', price: 5000, type: 'o', img: 'https://i.ibb.co/wZ3jmKdB/18.png' },
            { id: 'o20', name: 'Dark O', price: 5500, type: 'o', img: 'https://i.ibb.co/qM06Zvjb/20.png' },
            { id: 'o22', name: 'Gold O', price: 6000, type: 'o', img: 'https://i.ibb.co/G4d53tjd/22.png' },
            { id: 'o22a', name: 'Shine O', price: 6000, type: 'o', img: 'https://i.ibb.co/ycD36h8w/22.png' },
            { id: 'o24', name: 'Silver O', price: 6500, type: 'o', img: 'https://i.ibb.co/0pjnnyRF/24.png' },
            { id: 'o26', name: 'Bronze O', price: 7000, type: 'o', img: 'https://i.ibb.co/k2jxdwHY/26.png' },
            { id: 'o31', name: 'Diamond O', price: 10000, type: 'o', img: 'https://i.ibb.co/FL7HgjJn/31.png' },
            { id: 'o33', name: 'Ruby O', price: 8000, type: 'o', img: 'https://i.ibb.co/qLND0vB9/33.png' },
            { id: 'o34', name: 'Emerald O', price: 8500, type: 'o', img: 'https://i.ibb.co/pjNfBwTg/34.png' }
        ];

        const AVATARS = [
            { id: 'boy_def', name: 'Boy', price: 0, src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix&clothing=blazerAndShirt' },
            { id: 'girl_def', name: 'Girl', price: 0, src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Annie&hair=longHair' },
            { id: 'new_av1', name: 'Skull King', price: 3000, src: 'https://i.ibb.co/dszHdSmP/1.png' },
            { id: 'new_av2', name: 'Red Hood', price: 3000, src: 'https://i.ibb.co/pj0VPZvh/2.png' },
            { id: 'new_av3', name: 'Samurai', price: 3000, src: 'https://i.ibb.co/8DfrrG80/3.png' },
            { id: 'new_av4', name: 'Mask', price: 3000, src: 'https://i.ibb.co/bgGRbjHC/4.png' },
            { id: 'ninja', name: 'Ninja', price: 500, src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Ninja&clothing=hoodie&top=hat' },
            { id: 'king', name: 'King', price: 5000, src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=King&clothing=blazer&top=winterHat04&accessories=sunglasses' },
            { id: 'cyber', name: 'Cyber', price: 2000, src: 'https://api.dicebear.com/7.x/bottts/svg?seed=Cyborg' },
            { id: 'cool', name: 'Cool Kid', price: 1000, src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Cool&accessories=sunglasses' },
            { id: 'monster', name: 'Monster', price: 3000, src: 'https://api.dicebear.com/7.x/bottts/svg?seed=Monster&colors=amber' }
        ];

        let user = { 
            name: "Player", id: null, xp: 0, level: 1, coins: 500, diamonds: 0, streak: 0,
            inventory: ['def_x', 'def_o', 'boy_def'], equippedX: 'def_x', equippedO: 'def_o', currentAvatar: 'boy_def', emojis: []
        };
        
        let gameState = { mode: 'AI', turn: 'X', board: Array(9).fill(""), active: false, aiDiff: 'EASY' };
        // Added skins object to onlineState to track what players are using
        let onlineState = { gameID: null, role: 'X', opponentName: "Opponent", listeners: [], skins: { X: 'def_x', O: 'def_o' } };
        let activeShopTab = 'skins';
        let activeSkinType = 'x';
        let dynamicItems = []; 
        let currentEventItems = []; 

        window.onload = function() {
            const d = localStorage.getItem("ticUserFFMaxV3");
            if(d) { 
                user = JSON.parse(d); 
                if(!user.id) user.id = Math.floor(1000 + Math.random() * 9000).toString(); 
            }
            if(!user.inventory.includes('def_x')) user.inventory.push('def_x');
            if(!user.inventory.includes('def_o')) user.inventory.push('def_o');
            syncEventData();
            show('screen-launcher'); // Ensure the first screen is shown
        };

        function enterGame() {
            if(user.name && user.name !== "Player") { updateUI(); show('screen-menu'); } else { show('screen-setup'); }
        }
        
        function selGen(g) {
            document.querySelectorAll('.av-box').forEach(b => b.classList.remove('selected'));
            if(g==='boy') { document.getElementById('setup-boy').classList.add('selected'); user.currentAvatar='boy_def'; }
            else { document.getElementById('setup-girl').classList.add('selected'); user.currentAvatar='girl_def'; }
        }

        function getAllItems() { return [...SKINS, ...AVATARS, ...dynamicItems]; }

        function saveProfile() {
            user.name = document.getElementById('inp-name').value || "Player";
            if(!user.id) user.id = Math.floor(1000 + Math.random() * 9000).toString();
            saveUser(); updateUI(); show('screen-menu');
        }
        function saveUser() { localStorage.setItem("ticUserFFMaxV3", JSON.stringify(user)); updateUI(); }
        function updateUI() {
            document.getElementById('menu-name').innerText = user.name;
            let all = getAllItems();
            let av = all.find(a=>a.id===user.currentAvatar) || AVATARS[0];
            document.getElementById('menu-av').src = av.src || av.img;
            document.getElementById('menu-lvl').innerText = "Lvl " + user.level;
            document.getElementById('menu-xp').style.width = (user.xp%100)+"%";
            document.getElementById('coin-disp').innerText = user.coins;
            document.getElementById('dia-disp').innerText = user.diamonds || 0;
            document.getElementById('main-hud').style.display = 'flex';
        }

        function show(id) {
            if(id !== 'screen-lobby' && id !== 'screen-game') { resetOnlineListeners(); }
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-shop') renderShop();
            if(id === 'screen-launcher' || id === 'screen-setup') document.getElementById('main-hud').style.display = 'none';
            else if(user.name) document.getElementById('main-hud').style.display = 'flex';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function syncEventData() {
            db.ref('admin').once('value', s => {
                if(!s.exists()) { db.ref('admin').set({ items: [] }); } 
                else { const data = s.val(); if(data.items) dynamicItems = data.items; }
            });
        }

        // --- SHOP & EVENTS ---
        function openEvent() {
            show('screen-event');
            const ring = document.getElementById('ring-container');
            ring.innerHTML = "";
            let all = getAllItems();
            let potentialPrizes = all.filter(i => i.price >= 1500 && i.type !== 'emoji');
            if(potentialPrizes.length < 10) potentialPrizes = all.filter(i => i.price > 0);
            potentialPrizes.sort(() => Math.random() - 0.5);
            currentEventItems = potentialPrizes.slice(0, 10);
            currentEventItems.forEach((item, index) => {
                const node = document.createElement('div');
                node.className = 'hex-outer';
                node.id = `hex-${index}`;
                if(item.price >= 5000) node.classList.add('gold'); else node.classList.add('silver');
                let r = (index < 4) ? 90 : 150; 
                let angle = (index < 4) ? (index * (360/4)) : ((index-4) * (360/6));
                angle = angle * (Math.PI / 180);
                node.style.transform = `translate(${Math.cos(angle)*r-50}px, ${Math.sin(angle)*r}px)`;
                const imgUrl = item.img || item.src;
                node.innerHTML = `<div class="hex-inner"><img src="${imgUrl}"></div>`;
                node.onclick = () => {
                    document.querySelectorAll('.hex-outer').forEach(h => h.classList.remove('selected'));
                    node.classList.add('selected');
                    document.getElementById('preview-img').src = imgUrl;
                    document.getElementById('preview-name').innerText = item.name.toUpperCase();
                };
                ring.appendChild(node);
            });
            if(ring.children[0]) ring.children[0].click();
        }

        function spin(times) {
            // FIX: Check diamonds BEFORE playing sound
            const cost = times === 5 ? 20 : 5;
            if((user.diamonds || 0) < cost) { 
                showToast("Need more Diamonds! üíé"); 
                return; 
            }
            
            // Play sound only if diamonds exist
            playSound('spin');

            user.diamonds -= cost;
            saveUser();
            document.getElementById('btn-spin-1').disabled = true;
            document.getElementById('btn-spin-5').disabled = true;
            let spins = 0, maxSpins = 20, currentHex = 0;
            const ringNodes = document.querySelectorAll('.hex-outer');
            const interval = setInterval(() => {
                ringNodes.forEach(n => n.classList.remove('spinning'));
                if(ringNodes[currentHex]) ringNodes[currentHex].classList.add('spinning');
                currentHex = (currentHex + 1) % ringNodes.length;
                spins++;
                if(spins >= maxSpins) {
                    clearInterval(interval);
                    ringNodes.forEach(n => n.classList.remove('spinning'));
                    finalizeSpin(times);
                    document.getElementById('btn-spin-1').disabled = false;
                    document.getElementById('btn-spin-5').disabled = false;
                }
            }, 100);
        }
        
        function finalizeSpin(times) {
            playSound('event'); // Plays gift event sound
            let rewards = [];
            for(let i=0; i<times; i++) rewards.push(currentEventItems[Math.floor(Math.random() * currentEventItems.length)]);
            rewards.forEach(r => {
                let owned = (r.type==='emoji') ? user.emojis.includes(r.id) : user.inventory.includes(r.id);
                if(owned) { user.coins += 100; r.isDuplicate = true; } 
                else {
                    if(r.type==='emoji') user.emojis.push(r.id); else user.inventory.push(r.id);
                    r.isDuplicate = false;
                }
            });
            saveUser();
            showCongratulationModal(rewards);
        }

        function showCongratulationModal(rewards) {
            const m = document.getElementById('modal-congrats');
            const list = document.getElementById('reward-list');
            list.innerHTML = "";
            rewards.forEach((r, idx) => {
                const imgUrl = r.img || r.src;
                list.innerHTML += `
                    <div class="reward-card ${r.isDuplicate ? 'duplicate' : ''}" style="animation-delay:${idx*0.1}s">
                        <img src="${imgUrl}">
                        <span>${r.name}</span>
                        ${r.isDuplicate ? '<span style="color:gold; font-size:0.5rem;">+100 ü™ô</span>' : ''}
                    </div>
                `;
            });
            m.style.display = 'flex';
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        function closeCongrats() { document.getElementById('modal-congrats').style.display = 'none'; }

        // --- SHOP & COLLECTION ---
        function openCollection() { show('screen-collection'); renderCollection(); }
        function renderCollection() {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = "";
            let all = getAllItems();
            let myItems = [];
            all.forEach(item => { if(user.inventory.includes(item.id) || user.emojis.includes(item.id)) if(!myItems.find(i=>i.id===item.id)) myItems.push(item); });
            if(myItems.length === 0) { grid.innerHTML = "<p>No items found.</p>"; return; }
            myItems.forEach(i => {
                const imgUrl = i.img || i.src;
                let isEq = (i.type === 'avatar') ? (user.currentAvatar === i.id) : (i.type === 'x' ? user.equippedX === i.id : user.equippedO === i.id);
                let btn = isEq ? `<button class="btn-3d b-green" style="width:100%;font-size:0.6rem;padding:5px;cursor:default;">EQUIPPED</button>` : `<button class="btn-3d b-blue" style="width:100%;font-size:0.6rem;padding:5px;" onclick="equipFromCollection('${i.id}')">EQUIP</button>`;
                if(i.type === 'emoji') btn = `<button class="btn-3d b-purple" style="width:100%;font-size:0.6rem;padding:5px;">TAUNT</button>`;
                grid.innerHTML += `<div class="shop-item"><div style="height:60px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;"><img src="${imgUrl}" style="width:50px;height:50px;object-fit:contain;"></div><div style="font-size:0.7rem;font-weight:bold;margin-bottom:5px;">${i.name}</div>${btn}</div>`;
            });
        }
        function equipFromCollection(id) {
            playSound('tap');
            let item = getAllItems().find(i=>i.id===id);
            if(item) {
                if(item.type==='x') user.equippedX=id; else if(item.type==='o') user.equippedO=id; else if(item.type==='avatar') user.currentAvatar=id;
                saveUser(); updateUI(); renderCollection(); showToast("Equipped!");
            }
        }
        function switchShopTab(t) { 
            activeShopTab=t; 
            document.getElementById('tab-skins').className=t==='skins'?'tab-btn active':'tab-btn'; 
            document.getElementById('tab-avatars').className=t==='avatars'?'tab-btn active':'tab-btn'; 
            document.getElementById('skin-sub-tabs').style.display = t==='skins' ? 'flex' : 'none';
            renderShop(); 
        }
        function switchSkinType(type) { activeSkinType = type; document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active')); if(type==='x') document.getElementById('sub-x').classList.add('active'); if(type==='o') document.getElementById('sub-o').classList.add('active'); if(type==='emoji') document.getElementById('sub-e').classList.add('active'); renderShop(); }
        function renderShop() {
            const c = document.getElementById('shop-container'); c.innerHTML="";
            let list = []; let all = getAllItems();
            if(activeShopTab === 'skins') { if(activeSkinType === 'emoji') list = all.filter(s => s.type === 'emoji'); else list = all.filter(s => s.type === activeSkinType); } else { list = all.filter(s => s.type === 'avatar'); }
            list.forEach(i => {
                let owned = (i.type === 'emoji') ? user.emojis.includes(i.id) : user.inventory.includes(i.id);
                let isEq = false; if(activeShopTab==='skins' && i.type!=='emoji') isEq = (user.equippedX===i.id || user.equippedO===i.id); else if (activeShopTab==='avatars') isEq = (user.currentAvatar===i.id);
                let btn = owned ? (isEq ? `<button class="btn-3d b-green" style="width:100%;font-size:0.7rem;padding:8px;margin:0;cursor:default;">EQUIPPED</button>` : `<button class="btn-3d b-blue" style="width:100%;font-size:0.7rem;padding:8px;margin:0;" onclick="equip('${i.id}')">EQUIP</button>`) : `<button class="btn-3d b-gold" style="width:100%;font-size:0.8rem;padding:8px;margin:0;" onclick="buy('${i.id}',${i.price})">${i.price} ü™ô</button>`;
                if(owned && i.type==='emoji') btn = `<button class="btn-3d b-green" style="width:100%;font-size:0.7rem;padding:8px;margin:0;cursor:default;">OWNED</button>`;
                let imgUrl = i.img || i.src;
                let displayImg = imgUrl ? `<img src="${imgUrl}" style="width:50px;height:50px;object-fit:contain;">` : `<span style="font-size:2rem;font-weight:bold;color:#333;">${i.type==='x'?'X':'O'}</span>`;
                c.innerHTML += `<div class="shop-item"><div style="height:70px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;">${displayImg}</div><div style="font-weight:bold;font-size:0.8rem;margin-bottom:5px;">${i.name}</div>${btn}</div>`;
            });
        }
        function buy(id,p){ playSound('tap'); if(user.coins>=p){ user.coins-=p; user.inventory.push(id); saveUser(); updateUI(); renderShop(); showToast("Purchased! üéâ"); } else showToast("Need Coins! ü™ô"); }
        function equip(id){ playSound('tap'); let item = getAllItems().find(i=>i.id===id); if(activeShopTab==='skins') { if(item.type==='x') user.equippedX=id; else user.equippedO=id; } else user.currentAvatar=id; saveUser(); updateUI(); renderShop(); showToast("Equipped! ‚úÖ"); }

        // --- ADMIN ---
        function openAdmin() { document.getElementById('modal-admin-login').style.display = 'flex'; }
        function adminLogin() { if(document.getElementById('adm-email').value === 'ajayshakya1583@gmail.com' && document.getElementById('adm-pass').value === 'ajayshakya@9627') { document.getElementById('modal-admin-login').style.display = 'none'; loadAdminData(); show('screen-admin'); } else { alert("Access Denied"); } }
        function loadAdminData() { db.ref('admin').once('value', s => { const d = s.val() || {}; renderAdminItems(d.items || []); }); }
        function renderAdminItems(items) {
            const l = document.getElementById('adm-items-list'); l.innerHTML = "";
            items.forEach((i, idx) => { l.innerHTML += `<div class="admin-row" style="background:#222; padding:5px; border-radius:5px;"><b style="color:var(--gold)">${i.name}</b> (${i.type}) - ${i.price}ü™ô <br><small style="color:#777">${i.id}</small><button style="float:right; background:red; color:white; border:none; padding:2px 5px;" onclick="delAdminItem(${idx})">X</button></div>`; });
        }
        function addAdminItem() {
            const nid = document.getElementById('new-id').value; const nname = document.getElementById('new-name').value;
            const ntype = document.getElementById('new-type').value; const nimg = document.getElementById('new-img').value;
            const nprice = parseInt(document.getElementById('new-price').value) || 1000;
            if(!nid || !nname || !nimg) return alert("Fill all fields");
            const newItem = { id: nid, name: nname, type: ntype, price: nprice };
            if(ntype === 'avatar') newItem.src = nimg; else newItem.img = nimg;
            const newList = [...dynamicItems, newItem];
            db.ref('admin/items').set(newList).then(() => { dynamicItems = newList; loadAdminData(); alert("Item Added to Shop!"); });
        }
        function delAdminItem(idx) { dynamicItems.splice(idx, 1); db.ref('admin/items').set(dynamicItems); loadAdminData(); }

        // --- GAME LOGIC ---
        function preStartAI() { document.getElementById('difficulty-modal').style.display = 'flex'; }
        function selDiff(lvl) { gameState.aiDiff = lvl; document.getElementById('difficulty-modal').style.display = 'none'; initGame('AI'); }
        function startLocal() { initGame('LOCAL'); }
        
        function initGame(mode) {
            gameState.mode = mode; gameState.active = true; gameState.board.fill(""); gameState.turn = 'X';
            let all = getAllItems();
            let p1Av = all.find(a => a.id === user.currentAvatar) || AVATARS[0];
            document.getElementById('p1-name').innerText = user.name; 
            document.getElementById('p1-img').src = p1Av.src || p1Av.img;
            
            if(mode === 'AI') {
                document.getElementById('p2-name').innerText = `BOT (${gameState.aiDiff})`;
                document.getElementById('p2-img').src = "https://api.dicebear.com/7.x/bottts/svg?seed=" + gameState.aiDiff;
            } else if (mode === 'ONLINE') {
                document.getElementById('p2-name').innerText = onlineState.opponentName;
                document.getElementById('p2-img').src = "https://api.dicebear.com/7.x/avataaars/svg?seed=Opp";
            } else {
                document.getElementById('p2-name').innerText = "PLAYER 2";
                document.getElementById('p2-img').src = "https://api.dicebear.com/7.x/avataaars/svg?seed=P2";
            }
            drawBoard(); updateTurnUI(); show('screen-game');
            document.getElementById('taunt-menu').style.display = 'none';
        }
        
        function drawBoard() {
            const g = document.getElementById('grid'); g.innerHTML = "";
            gameState.board.forEach((c, i) => {
                const d = document.createElement('div'); d.className = 'cell';
                d.id = `cell-${i}`;
                if(c) {
                    let skinId = 'def_x';
                    if(gameState.mode === 'ONLINE') {
                        // Use synced skin data
                        skinId = onlineState.skins[c] || (c==='X' ? 'def_x' : 'def_o');
                    } else {
                        skinId = (c==='X') ? user.equippedX : user.equippedO;
                    }

                    let all = getAllItems();
                    let skin = all.find(s => s.id === skinId);
                    
                    if(skin && (skin.img || skin.src)) { 
                        d.innerHTML = `<img src="${skin.img || skin.src}" class="skin-img">`; 
                    } else { 
                        d.innerHTML = `<span>${c}</span>`; 
                    }
                }
                d.onclick = () => tap(i);
                g.appendChild(d);
            });
        }
        
        function tap(i) {
            if(!gameState.active || gameState.board[i]) return;
            if(gameState.mode === 'ONLINE' && gameState.turn !== onlineState.role) return;
            if(gameState.mode === 'AI' && gameState.turn === 'O') return;

            makeMove(i, gameState.turn);
            
            if(gameState.mode === 'AI' && gameState.active && gameState.turn === 'O') {
                setTimeout(botMove, 600);
            }
        }
        
        function makeMove(i, p) {
            playSound('move');
            if(gameState.mode === 'ONLINE') {
                const nextTurn = p === 'X' ? 'O' : 'X';
                let newBoard = [...gameState.board];
                newBoard[i] = p;
                
                db.ref(`games/${onlineState.gameID}`).update({
                    board: newBoard,
                    turn: nextTurn
                });
            } else {
                gameState.board[i] = p;
                drawBoard();
                let win = checkWinVal(gameState.board);
                if(win) return endGame(win);
                if(!gameState.board.includes("")) return endGame('DRAW');
                gameState.turn = p==='X'?'O':'X';
                updateTurnUI();
            }
        }

        // --- ONLINE ---
        function switchTab(t) {
            document.getElementById('tab-global').style.display = t==='global'?'block':'none';
            document.getElementById('tab-code').style.display = t==='code'?'flex':'none';
        }

        function modeLobby() {
            gameState.mode = 'ONLINE';
            show('screen-lobby');
            document.getElementById('my-code-disp').innerText = user.id;

            const myRef = db.ref(`lobby/${user.id}`);
            myRef.set({ name: user.name, status: 'online' });
            myRef.onDisconnect().remove();

            const lobbyRef = db.ref('lobby');
            lobbyRef.on('value', snapshot => {
                const list = document.getElementById('lobby-list');
                list.innerHTML = "";
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const p = child.val();
                        const pid = child.key;
                        if(pid !== user.id) {
                            list.innerHTML += `
                                <div class="lobby-player">
                                    <div><span class="status-dot"></span><b>${p.name}</b> <small>(${pid})</small></div>
                                    <button class="btn-3d b-green" style="width:auto; padding:5px 15px; font-size:0.8rem; margin:0;" onclick="sendChallenge('${pid}'); playSound('tap')">‚öîÔ∏è</button>
                                </div>`;
                        }
                    });
                } else {
                    list.innerHTML = "<p style='padding:10px; color:#777;'>No players online.</p>";
                }
            });
            onlineState.listeners.push(lobbyRef);

            const reqRef = db.ref(`requests/${user.id}`);
            reqRef.on('value', snapshot => {
                if(snapshot.exists()) {
                    const req = snapshot.val();
                    document.getElementById('chal-msg').innerHTML = `<b>${req.name}</b> challenges you!`;
                    document.getElementById('challenge-modal').style.display = 'flex';
                    // Pass req.skin (Opponent's skin) to acceptChallenge
                    document.getElementById('btn-accept').onclick = () => acceptChallenge(req.from, req.name, req.skin);
                } else {
                    document.getElementById('challenge-modal').style.display = 'none';
                }
            });
            onlineState.listeners.push(reqRef);

            const myStatusRef = db.ref(`lobby/${user.id}/gameID`);
            myStatusRef.on('value', snap => {
                if(snap.exists()) {
                    const gid = snap.val();
                    joinGame(gid, 'X'); 
                }
            });
            onlineState.listeners.push(myStatusRef);
        }
        
        function modeInvite() {
             switchTab('code');
             modeLobby(); 
        }

        function sendChallenge(targetId) {
            // Include equipped X skin in request
            db.ref(`requests/${targetId}`).set({
                from: user.id,
                name: user.name,
                skin: user.equippedX 
            });
            showToast("Challenge Sent! ‚è≥");
        }

        function challengeByCode() {
            const code = document.getElementById('friend-code-in').value;
            if(code && code !== user.id) {
                sendChallenge(code);
            } else {
                showToast("Invalid Code! ‚ùå");
            }
        }

        function rejectChallenge() {
            db.ref(`requests/${user.id}`).remove();
            document.getElementById('challenge-modal').style.display = 'none';
        }

        function acceptChallenge(challengerId, challengerName, challengerSkin) {
            playSound('tap');
            const gameID = "game_" + Date.now() + "_" + Math.floor(Math.random()*1000);
            // Save BOTH skins to the game node
            db.ref(`games/${gameID}`).set({
                board: Array(9).fill(""),
                turn: 'X',
                players: { X: challengerId, O: user.id },
                names: { X: challengerName, O: user.name },
                skins: { X: challengerSkin || 'def_x', O: user.equippedO },
                active: true
            }).then(() => {
                db.ref(`lobby/${challengerId}`).update({ gameID: gameID });
                db.ref(`requests/${user.id}`).remove();
                joinGame(gameID, 'O', challengerName);
            });
        }

        function joinGame(gid, role, oppNameOverride) {
            onlineState.gameID = gid;
            onlineState.role = role;
            
            resetOnlineListeners();

            if(oppNameOverride) onlineState.opponentName = oppNameOverride;
            else {
                db.ref(`games/${gid}/names/${role==='X'?'O':'X'}`).once('value', s => {
                    onlineState.opponentName = s.val() || "Opponent";
                });
            }

            // Fetch initial skins
            db.ref(`games/${gid}/skins`).once('value', s => {
                if(s.exists()) onlineState.skins = s.val();
            });

            setTimeout(() => initGame('ONLINE'), 500);

            const gameRef = db.ref(`games/${gid}`);
            gameRef.on('value', snap => {
                if(!snap.exists()) {
                    alert("Opponent Disconnected! You Win! üèÜ");
                    quitGame();
                    return;
                }

                const data = snap.val();
                gameState.board = data.board || Array(9).fill("");
                gameState.turn = data.turn;
                if(data.skins) onlineState.skins = data.skins;
                
                if(data.names) {
                     const oppRole = role==='X'?'O':'X';
                     document.getElementById('p2-name').innerText = data.names[oppRole] || "Opponent";
                }

                if(data.taunt && data.taunt.from !== role && Date.now() - data.taunt.t < 3000) {
                     showFloatingEmoji(data.taunt.url, 'p2-card');
                }
                
                drawBoard();
                
                const w = checkWinVal(gameState.board);
                if(w) endGame(w);
                else if(!gameState.board.includes("")) endGame('DRAW');
                else updateTurnUI();
            });
            onlineState.listeners.push(gameRef);
        }

        function exitOnline() {
            resetOnlineListeners();
            if(user.id) {
                db.ref(`lobby/${user.id}`).remove();
                db.ref(`requests/${user.id}`).remove();
            }
            show('screen-menu');
        }

        function resetOnlineListeners() {
            onlineState.listeners.forEach(ref => ref.off());
            onlineState.listeners = [];
        }

        // --- BOT ---
        function botMove() {
            if(!gameState.active) return;
            if(gameState.aiDiff === 'EASY') { makeRandomMove(); return; }
            if(gameState.aiDiff === 'HARD') {
                if(Math.random() > 0.3) { makeBestMove(); } else { makeRandomMove(); }
                return;
            }
            if(gameState.aiDiff === 'IMPOSSIBLE') { makeBestMove(); }
        }

        function makeRandomMove() {
            let empty = [];
            gameState.board.forEach((v, i) => { if(v==="") empty.push(i); });
            if(empty.length > 0) {
                let idx = empty[Math.floor(Math.random()*empty.length)];
                makeMove(idx, 'O');
            }
        }

        function makeBestMove() {
            let bestScore = -Infinity;
            let move;
            for(let i=0; i<9; i++) {
                if(gameState.board[i] === '') {
                    gameState.board[i] = 'O';
                    let score = minimax(gameState.board, 0, false);
                    gameState.board[i] = '';
                    if(score > bestScore) { bestScore = score; move = i; }
                }
            }
            makeMove(move, 'O');
        }

        function minimax(board, depth, isMaximizing) {
            let result = checkWinVal(board);
            if(result === 'O') return 10 - depth;
            if(result === 'X') return depth - 10;
            if(!board.includes('')) return 0;

            if(isMaximizing) {
                let bestScore = -Infinity;
                for(let i=0; i<9; i++) {
                    if(board[i] === '') {
                        board[i] = 'O';
                        let score = minimax(board, depth+1, false);
                        board[i] = '';
                        bestScore = Math.max(score, bestScore);
                    }
                }
                return bestScore;
            } else {
                let bestScore = Infinity;
                for(let i=0; i<9; i++) {
                    if(board[i] === '') {
                        board[i] = 'X';
                        let score = minimax(board, depth+1, true);
                        board[i] = '';
                        bestScore = Math.min(score, bestScore);
                    }
                }
                return bestScore;
            }
        }
        
        function checkWinVal(bd) {
             const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
             for(let c of w) if(bd[c[0]] && bd[c[0]]===bd[c[1]] && bd[c[0]]===bd[c[2]]) return bd[c[0]];
             return null;
        }

        function endGame(w) {
            gameState.active = false;
            let myRole = (gameState.mode==='ONLINE' ? onlineState.role : 'X');
            let iWon = (w === myRole);
            
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            if(w !== 'DRAW') {
                for(let c of wins) {
                    if(gameState.board[c[0]]===w && gameState.board[c[1]]===w && gameState.board[c[2]]===w) {
                        document.getElementById(`cell-${c[0]}`).classList.add('winning');
                        document.getElementById(`cell-${c[1]}`).classList.add('winning');
                        document.getElementById(`cell-${c[2]}`).classList.add('winning');
                    }
                }
            }

            setTimeout(() => {
                if(w === 'DRAW') {
                    playSound('draw');
                    showResult('DRAW', "Close Call!", 10, 5, 'DRAW');
                } else if (iWon) {
                    playSound('win');
                    user.streak = (user.streak || 0) + 1;
                    // Trigger Box every 3rd win
                    if(user.streak % 3 === 0) { 
                        setTimeout(()=>{ 
                            document.getElementById('modal-mystery').style.display = 'flex'; 
                            // Remove shaking effect if present from previous
                            document.getElementById('mystery-box-anim').classList.remove('shaking');
                        }, 1000); 
                        return; 
                    }
                    showResult('VICTORY!', "You Dominated!", 50, 20, 'WIN');
                } else {
                    playSound('draw');
                    user.streak = 0;
                    showResult('DEFEAT', "Better luck next time", 5, 5, 'LOSE');
                }
                saveUser();
            }, 800);
        }

        function showResult(tit, msg, xp, c, type) {
            const m = document.getElementById('modal-result');
            const box = document.getElementById('res-box');
            m.style.display='flex';
            
            document.getElementById('res-title').innerText = tit;
            document.getElementById('res-msg').innerText = msg;
            
            box.classList.remove('result-box-win', 'result-box-draw');
            
            if(type === 'WIN') {
                box.classList.add('result-box-win');
                document.getElementById('res-emoji').innerText = "üèÜ";
                document.getElementById('res-title').style.color = "var(--gold)";
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#ffd700', '#ff47b6', '#00d2ff'] });
            } else if (type === 'DRAW') {
                box.classList.add('result-box-draw');
                document.getElementById('res-emoji').innerText = "ü§ù";
                document.getElementById('res-title').style.color = "#777";
            } else {
                document.getElementById('res-emoji').innerText = "üíÄ";
                document.getElementById('res-title').style.color = "var(--red)";
            }
            
            user.xp+=xp; user.coins+=c; saveUser();
        }
        
        // --- NEW BOX LOGIC (50% Chance Implementation) ---
        function openBox() {
            const boxAnim = document.getElementById('mystery-box-anim');
            // Add UI Effect (Shake)
            boxAnim.classList.add('shaking');
            playSound('tap');

            // Wait 1.5 seconds for dramatic effect
            setTimeout(() => {
                boxAnim.classList.remove('shaking');
                document.getElementById('modal-mystery').style.display='none';

                // ---------------------------------------------------------
                // MAIN LOGIC: 100% me se 50% ko hi milega
                // ---------------------------------------------------------
                const isLucky = Math.random() < 0.5; 

                if (isLucky) {
                    // 50% Log Jinko Gift Milega (Diamonds)
                    playSound('gift'); // Happy Sound
                    user.diamonds = (user.diamonds||0) + 10;
                    showResult('JACKPOT!', `You won 10 Diamonds! üíé`, 100, 50, 'WIN');
                } else {
                    // 50% Log Jinko Gift NAHI milega (Sirf Coins)
                    playSound('draw'); // Sad Sound
                    user.coins = (user.coins||0) + 50;
                    showResult('BAD LUCK', `Box was empty!\nGot 50 Coins only.`, 10, 50, 'DRAW');
                }
                saveUser();
            }, 1500);
        }

        function restartGame() { document.getElementById('modal-result').style.display='none'; if(gameState.mode==='ONLINE') quitGame(); else initGame(gameState.mode); }
        
        function quitGame() { 
            if(gameState.mode === 'ONLINE') {
                if(onlineState.gameID) db.ref(`games/${onlineState.gameID}`).remove();
                exitOnline();
            }
            document.getElementById('modal-result').style.display='none'; show('screen-menu'); 
        }

        function updateTurnUI() {
            const t = document.getElementById('turn-ind');
            const myTurn = (gameState.mode === 'ONLINE' ? gameState.turn === onlineState.role : gameState.turn === 'X');
            t.innerText = myTurn ? "YOUR TURN" : "OPPONENT TURN";
            t.style.color = myTurn ? "var(--cyan)" : "var(--pink)";
            document.getElementById('p1-card').style.opacity = myTurn?1:0.5;
            document.getElementById('p2-card').style.opacity = myTurn?0.5:1;
        }
        
        function toggleTauntMenu() {
            playSound('tap');
            const m = document.getElementById('taunt-menu');
            if(m.style.display === 'flex') { m.style.display='none'; return; }
            m.innerHTML = "";
            let list = [];
            if(user.emojis) user.emojis.forEach(eid => { let em = getAllItems().find(i=>i.id===eid); if(em) list.push(em); });
            if(list.length===0) m.innerHTML = "<small style='color:white'>No emojis owned.</small>";
            list.forEach(e => {
                const b = document.createElement('button'); b.className = 'taunt-btn';
                b.innerHTML = `<img src="${e.img || e.src}">`;
                b.onclick = () => sendTaunt(e.img || e.src);
                m.appendChild(b);
            });
            m.style.display = 'flex';
        }
        function sendTaunt(url) {
            document.getElementById('taunt-menu').style.display='none';
            showFloatingEmoji(url, 'p1-card');
            if(gameState.mode === 'ONLINE' && onlineState.gameID) {
                db.ref(`games/${onlineState.gameID}/taunt`).set({ t: Date.now(), url: url, from: onlineState.role });
            }
        }
        function showFloatingEmoji(url, targetId) {
            playSound('tap');
            const t = document.getElementById(targetId);
            const el = document.createElement('div'); el.className = 'float-emoji';
            el.innerHTML = `<img src="${url}" style="width:50px; height:50px;">`;
            t.appendChild(el); setTimeout(()=>el.remove(), 2000);
        }

    </script>
</body>
</html>
